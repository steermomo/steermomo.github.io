<!DOCTYPE html>
<html lang="en">

<head>
        <meta name="google-site-verification" content="d0pvXqLPH8JyCfWVyhZ7njhGUndRFIR95YM3myMb7rU" />
        <meta charset="utf-8" />
        <meta http-equiv="Cache-Control" content="no-transform" />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=yes" />
        <title>SIFTç®—æ³•åŠPythonå®ç°</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


        <link rel="stylesheet" href="//unpkg.com/heti/umd/heti.min.css">

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <!-- <h1><a href="/">steer </a></h1> -->
                <nav>
                        <ul>
                                <li><a href="/">ğŸ¦‰</a></li>
                                <li><a href="/blog">Blog</a></li>
                                <li><a href="/archives">Archives</a></li>
                                <li><a href="/gallery">Gallery</a></li>
                                <li id="navName">steer </li>
                        </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/blog/2019/06/siftsuan-fa-ji-pythonshi-xian" rel="bookmark" title="Permalink to SIFTç®—æ³•åŠPythonå®ç°">SIFTç®—æ³•åŠPythonå®ç°</a>
      </h1>
    </header>

    <div class="entry-content">
<div class="post-meta">
        Date: <span >
               2019-06-28 Fri
        </span>
<span>Category: <a href="/category/coding/">coding</a></span>
<!--  -->

</div><!-- /.post-info -->

      <h4>ç©ºé—´æå€¼æ£€æµ‹</h4>
<p>SIFTç®—æ³•éœ€è¦åœ¨å°ºåº¦ç©ºé—´ä¸­å¯»æ‰¾å…³é”®ç‚¹.</p>
<p>é¦–å…ˆéœ€è¦å¯¹ç›¸åŒç‰©ä½“åœ¨ä¸åŒå°ºåº¦ä¸‹è¿›è¡Œå®šä½, å› æ­¤ä½¿ç”¨ç‰¹å¾é‡‘å­—å¡”å®Œæˆè¿™ä¸€ç›®çš„.</p>
<p>å¯¹å°ºåº¦ç©ºé—´çš„æœç´¢å¾—åˆ°çš„ç‰¹å¾èƒ½å¤Ÿæ»¡è¶³å°ºç¼©ä¸å˜æ€§.</p>
<h5>ç©ºé—´é‡‘å­—å¡”</h5>
<h6>é«˜æ–¯æ ¸</h6>
<p>å®ç°å°ºç¼©å˜æ¢çš„å”¯ä¸€å˜æ¢æ ¸æ˜¯é«˜æ–¯æ ¸.</p>
<p>å¯¹äºè¾“å…¥å›¾åƒ$I(x,y )$, ä½¿ç”¨é«˜æ–¯æ ¸$G(x, y, \sigma)$åšå·ç§¯, å½¢å¼å¦‚ä¸‹.
$$
L(x, y, \sigma)=G(x, y, \sigma) \ast I(x, y)
$$
é€šè¿‡ä½¿ç”¨ä¸åŒçš„$\sigma$, ç›¸å½“äºå¯¹å›¾åƒåšä¸åŒç¨‹åº¦çš„é«˜æ–¯æ¨¡ç³Š, å³å¾—åˆ°ä¸åŒå°ºåº¦çš„å›¾åƒ.</p>
<h6>é«˜æ–¯å·®åˆ†è¿‘ä¼¼å½’ä¸€åŒ–æ‹‰æ™®æ‹‰æ–¯</h6>
<p>Mikolajczyk(2002) å‘ç°å°ºåº¦å½’ä¸€åŒ–çš„æ‹‰æ™®æ‹‰æ–¯é«˜æ–¯å‡½æ•°$\sigma^2\nabla^2G$çš„æå¤§æå°å€¼, ç›¸æ¯”äºå…¶ä»–ç‰¹å¾æ–¹æ³•, èƒ½å¤Ÿäº§ç”Ÿæœ€ç¨³å®šçš„å›¾åƒç‰¹å¾.</p>
<p>åŒæ—¶, ä¸ºäº†æœ‰æ•ˆåœ°æ£€æµ‹ç¨³å®šå…³é”®ç‚¹çš„ä½ç½®, æœ¬æ–‡ä½œè€…(Lowe, 1999)ä½¿ç”¨å·®åˆ†é«˜æ–¯DOGçš„å°ºåº¦ç©ºé—´æå€¼ä½œä¸ºç‰¹å¾.   å·®åˆ†é«˜æ–¯æ˜¯ç›¸é‚»å°ºåº¦çš„å·®å€¼, å°ºåº¦å·®è·æœ‰å¸¸æ•°å› å­$k$å†³å®š.
$$
D(x, y, \sigma)=\left(G(x, y, k\sigma)-G(x, y, \sigma) \right)\ast I(x, y)\
=L(x, y, k\sigma)-L(x, y, \sigma)
$$
è€ŒLindeberg(1994)å‘ç°è¿™ä¸¤ç§æ–¹å¼æ˜¯è¿‘ä¼¼çš„, é€šè¿‡å¯¹$G$å¯¹$\sigma$æ±‚åå¯¼å¯å¾—,
$$
\frac{\partial G}{\partial \sigma}=\sigma\nabla^2G
$$
ç”¨å·®åˆ†è¿‘ä¼¼å¾®åˆ†, å¯å¾—
$$
\sigma\nabla^2G=\frac{\partial G}{\partial \sigma}\simeq \frac{G(x, y, k\sigma)-G(x, y,\sigma)}{k\sigma-\sigma}
$$</p>
<p>å˜æ¢åˆ†æ¯ä½ç½®å¯å¾—
$$
G(x, y, k\sigma)-G(x, y, \sigma)\simeq(k-1)\sigma^2\nabla^2G
$$
å½“$k$è¶‹å‘äº1æ—¶, è¯¯å·®è¶‹å‘äº0.</p>
<p>å› æ­¤æœ¬æ–‡ä½œè€…ä½¿ç”¨é«˜æ–¯å·®åˆ†ä»£æ›¿å½’ä¸€åŒ–æ‹‰æ™®æ‹‰æ–¯å‡½æ•°è¿›è¡Œæ£€æµ‹.</p>
<h6>å·®åˆ†é«˜æ–¯çš„æ„é€ </h6>
<p>ä¸‹å›¾è¡¨ç¤ºäº†å¦‚ä½•æœ‰æ•ˆåœ°æ„å»ºå·®åˆ†æ‹‰æ™®æ‹‰æ–¯.</p>
<p><img alt="" src="https://img-my.csdn.net/uploads/201204/28/1335626876_5968.jpg"></p>
<p>é«˜æ–¯é‡‘å­—å¡”æœ‰$n$å±‚, å½“é«˜æ–¯æ ¸çš„$\sigma$ç¿»å€æ—¶, å°†å›¾åƒå½’ä¸ºä¸€ç»„(Octave), ä¸‹ä¸€å¼ å›¾åƒå°†ä¸‹é‡‡æ ·ä¸€æ¬¡.</p>
<p>åˆå§‹çš„å›¾åƒä½¿ç”¨é«˜æ–¯æ ¸è¿›è¡Œå·ç§¯, ä»¤ç¬¬ä¸€å¼ å›¾åƒçš„é«˜æ–¯æ ¸å‚æ•°ä¸º$\sigma_0$, åç»­æ¯å¼ å›¾åƒçš„é«˜æ–¯æ ¸å‚æ•°ä¸º$k\sigma_0$, $k$ä¸ºå›¾åƒç´¢å¼•(ä»1å¼€å§‹).</p>
<p>å¦‚æœæ¯ç»„å†…æœ‰$s$å¼ å›¾åƒ, åˆ™æœ‰
$$
k^s=2
$$
å› æ­¤$k=2^{1/s}$. </p>
<p>ä¸ºäº†åœ¨æ¯ç»„æ£€æµ‹$s$ä¸ªå°ºåº¦çš„æå€¼ç‚¹(æ¯ä¸ªæå€¼ç‚¹éœ€è¦è·Ÿä¸Šä¸‹å±‚æ¯”è¾ƒ), åˆ™DOG éœ€è¦$s+2$å±‚, é«˜æ–¯é‡‘å­—å¡”æ¯ç»„éœ€è¦$s+3$å±‚.</p>
<h6>é«˜æ–¯é‡‘å­—å¡”çš„ç”Ÿæˆè¿‡ç¨‹</h6>
<p>ä¹‹å‰æ„é€ å·®åˆ†é«˜æ–¯é‡‘å­—å¡”éœ€è¦å…ˆæ„é€ é«˜æ–¯é‡‘å­—å¡”.  </p>
<ul>
<li>å¯¹äºä¸€å¹…è¾“å…¥å›¾åƒ, é¦–å…ˆæ„é€ é«˜æ–¯é‡‘å­—å¡”çš„ç¬¬1ç»„, å› ä¸ºé«˜æ–¯é‡‘å­—å¡”æ¯ç»„éœ€è¦$s+3$å±‚, ä»¤ç¬¬ä¸€å±‚çš„é«˜æ–¯æ ¸å°ºåº¦ä¸º$\sigma_0$, åˆ™ä¾æ¬¡ä½¿ç”¨$k^0\sigma, k\sigma, k^2\sigma, \cdots, k^s\sigma, k^{s+1}\sigma, k^{s+2}\sigma$çš„å°ºåº¦, ç”Ÿæˆå¯¹åº”å°ºåº¦çš„å›¾åƒ. å…¶ä¸­$k=2^{1/s}$.</li>
<li>æ¥ç€æ„é€ ç¬¬2ç»„çš„å›¾åƒ, å› ä¸ºç¬¬2ç»„çš„ç¬¬1å¼ å›¾åƒçš„å°ºåº¦$\sigma$åº”è¯¥æ˜¯ç¬¬1ç»„çš„2å€, å› ä¸º$k^s=2$, å› æ­¤é€‰æ‹©ç¬¬1ç»„çš„å€’æ•°ç¬¬3å¼ , å¹¶ä¸‹é‡‡æ ·ä¸€æ¬¡, ä½œä¸ºç¬¬2ç»„çš„ç¬¬1å¼ å›¾åƒ.</li>
<li>ä¾æ¬¡æ„å»ºæ¥ä¸‹æ¥çš„å„ç»„, ç›´åˆ°æ‰“åˆ°ç»„æ•°è¦æ±‚æˆ–è€…ä¸‹é‡‡æ ·åˆ°æŒ‡å®šå¤§å°.</li>
</ul>
<h5>å±€éƒ¨æå€¼æ£€æµ‹</h5>
<p>å¾—åˆ°å·®åˆ†é«˜æ–¯é‡‘å­—å¡”å, éœ€è¦æ£€æµ‹æå€¼ç‚¹. </p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤º, æ¯ä¸ªç‚¹éœ€è¦ä¸8ä¸ªä¸´ç•Œç‚¹è¿›è¡Œæ¯”è¾ƒ, å¦‚æœè¯¥ç‚¹æ˜¯è¿™9ä¸ªç‚¹ä¸­æœ€å¤§æˆ–æœ€å°çš„ç‚¹, åˆ™ä½œä¸ºæå€¼ç‚¹.</p>
<p><img alt="" src="https://img-my.csdn.net/uploads/201204/28/1335626904_5751.jpg"></p>
<p>è¿™ç§æ–¹æ³•çš„ä¸€ä¸ªé—®é¢˜æ˜¯, å°ºåº¦çš„é‡‡æ ·é¢‘ç‡ä¼šå½±å“åˆ°æå€¼ç‚¹çš„æ£€æµ‹, å½“ç„¶è¶Šå°çš„é‡‡æ ·é—´éš”ä¼šå¾—åˆ°è¶Šå¤šçš„æå€¼ç‚¹. å¦‚æœè¦æ£€æµ‹åˆ°æ‰€æœ‰çš„æå€¼ç‚¹, éœ€è¦æ— é™å°çš„é‡‡æ ·é—´éš”(æå€¼ç‚¹é—´çš„è·ç¦»å¯èƒ½ååˆ†å°). </p>
<p>æ— é™å°çš„é‡‡æ ·é—´è·æ˜¯ä¸å®é™…çš„, è¿™é‡Œéœ€è¦åœ¨æ£€æµ‹æ•ˆæœå’Œé‡‡æ ·é¢‘ç‡ä¹‹é—´åšå¹³è¡¡.</p>
<h6>å°ºåº¦é‡‡æ ·é¢‘ç‡</h6>
<p>å¯¹äºé«˜æ–¯é‡‘å­—å¡”, å·²ç»æ˜ç¡®äº†, ç›¸é‚»ç»„é—´çš„å°ºåº¦å·®è·æ˜¯2å€, ä½†æ˜¯ç»„å†…çš„å›¾ç‰‡æ•°é‡å¹¶æ²¡æœ‰ç¡®å®š.</p>
<p>è®ºæ–‡é€šè¿‡å®éªŒç¡®å®šç»„å†…çš„å›¾ç‰‡æ•°é‡, é€šè¿‡æ¯”è¾ƒ$s=1,2,3,\cdots,8$ çš„ç»“æœ, ç»“æœæ˜¾ç¤ºæ£€æµ‹æ•ˆæœåœ¨$s=3$æ—¶è¾¾åˆ°æœ€ä½³, éšåä¼šç•¥å¾®ä¸‹é™. </p>
<p>è™½ç„¶æ›´å¤§çš„$s$ä¼šæ£€æµ‹å‡ºæ›´å¤šçš„æå€¼ç‚¹, ä½†è¿™äº›ç‚¹å¯èƒ½ä¼šä¸ç¨³å®š, å› æ­¤å¯¼è‡´äº†æ£€æµ‹æ•ˆæœçš„ä¸‹é™.</p>
<h6>ç©ºé—´é‡‡æ ·é¢‘ç‡</h6>
<p>é«˜æ–¯é‡‘å­—å¡”ä¸­å¦ä¸€ä¸ªæœªç¡®å®šçš„å‚æ•°æ˜¯ç¬¬1å¼ å›¾åƒçš„å°ºåº¦$\sigma_0$,  é€šè¿‡ç±»ä¼¼çš„å®éªŒ, é€‰æ‹©$\sigma_0$ä¸º1.6.</p>
<p>ä½†æ˜¯è¿™æ ·ç›¸å½“äºç›´æ¥ä¸¢æ‰äº†æœ€é«˜ç©ºåŸŸçš„é‡‡æ ·ç‡.  åŸå§‹å›¾åƒçš„$\sigma_{-1}$ä¸º0.5,  å¯¹å…¶ä½¿ç”¨åŒçº¿æ€§æ’å€¼å°†å°ºå¯¸æ‰©å¤§ä¸€å€, ç›¸å½“äº$\sigma_{-1}=1.0$, é€šè¿‡æ‰©å¤§åŸå§‹å›¾ç‰‡å°ºå¯¸çš„æ–¹å¼ç”Ÿæˆç¬¬-1ç»„.</p>
<p>å°†å°ºå¯¸æ‰©å¤§ä¸€å€, å¯ä½¿å¾—å…³é”®ç‚¹çš„æ•°é‡å˜ä¸ºåŸæ¥çš„4å€. ä½†æ˜¯æ‰©å¤§æ›´å¤§çš„å€æ•°ä¸å†èƒ½æ˜¾è‘—å¢åŠ å…³é”®ç‚¹çš„æ•°é‡.</p>
<h4>å…³é”®ç‚¹ç²¾ç¡®å®šä½</h4>
<p>å±€éƒ¨æå€¼æ£€æµ‹ä¸­, æ˜¯å¯¹ç¦»æ•£å€¼çš„æ£€æµ‹. ä¸‹ä¸€æ­¥éœ€è¦åšå®šä½, ç¡®å®šå°ºåº¦å’Œä¸»æ›²ç‡, ç”¨äºå‰”é™¤ä½å¯¹æ¯”åº¦(å™ªå£°æ•æ„Ÿ)æˆ–è€…æ˜¯ä¸ç¨³å®šè¾¹ç¼˜å“åº”.</p>
<h5>æ³°å‹’å±•å¼€æ‹Ÿåˆ</h5>
<p>(Brown and Lowe, 2002) æå‡ºäº†3DäºŒæ¬¡å‡½æ•°å¯¹æå€¼ç‚¹ä½ç½®è¿›è¡Œæ’å€¼, å®éªŒè¡¨æ˜è¿™ç§æ–¹æ³•æå‡äº†åŒ¹é…æ•ˆæœå’Œç¨³å®šæ€§.</p>
<p>ä½¿ç”¨DOGå‡½æ•°åœ¨å°ºåº¦ç©ºé—´çš„æ³°å‹’å±•å¼€å¼, ä»¤æ ·æœ¬ç‚¹ä¸ºåŸç‚¹, æœ‰
$$
D(x)=D+\frac{\partial D^T}{\partial x}X + \frac{1}{2}X^T\frac{\partial^2D}{\partial x^2}X
$$
å…¶ä¸­$X=(x, y, \sigma)^T$æ˜¯ç¦»æ ·æœ¬ç‚¹çš„åç§». å°†ä¸Šå¼å¯¹Xæ±‚åå¯¼, ä»¤ç»“æœä¸º0, å¯å¾—æå€¼ç‚¹çš„ä½ç½®åç§»é‡.
$$
\hat{X}=-\frac{\partial^2D^{-1}}{\partial X^2}\frac{\partial D}{\partial X}
$$
å¦‚æœ$\hat{X}$å¤§äº0.5, åˆ™æå€¼ç‚¹åç§»åˆ°ä¸´è¿‘ç‚¹ä¸Š, éœ€è¦æ”¹å˜æ ·æœ¬ç‚¹çš„ä½ç½®, å¹¶åœ¨æ–°çš„ä½ç½®ä¸Šé‡å¤è¿™ä¸€è®¡ç®—, ç›´åˆ°æ”¶æ•›. å½“è¶…è¿‡è¿­ä»£æ¬¡æ•°æˆ–è¶…å‡ºå›¾åƒèŒƒå›´æ—¶, éœ€è¦åˆ é™¤è¯¥ç‚¹.</p>
<h5>æ¶ˆé™¤ä½å¯¹æ¯”åº¦ç‚¹</h5>
<p>å¯¹äºä¸Šä¸€æ­¥ä¸­æ±‚å¾—çš„$\hat{X}$, å¸¦å…¥åŸå¼å¯å¾—
$$
D(\hat{X})=D+\frac{1}{2}\frac{\partial D^T}{\partial X} \hat{X}
$$
ä¸ºäº†æ¶ˆé™¤ä½å¯¹æ¯”åº¦çš„ç‚¹, æ–‡ä¸­å‰”é™¤äº†$|D(\hat{X}|$å°äº0.03çš„ç‚¹.</p>
<h5>æ¶ˆé™¤è¾¹ç¼˜å“åº”</h5>
<p>ä¸ºäº†ç¨³å®šæ€§, åªå‰”é™¤ä½å¯¹æ¯”åº¦ç‚¹æ˜¯ä¸å¤Ÿçš„. DOGç®—å­å¯¹è¾¹ç¼˜æœ‰è¾ƒå¼ºçš„å“åº”, å³ä½¿è¯¥è¾¹ç¼˜å¹¶ä¸æ˜¾è‘—.</p>
<p>æœ‰äº›æå€¼ç‚¹çš„ä½ç½®æ˜¯åœ¨å›¾åƒçš„è¾¹ç¼˜ä½ç½®çš„ï¼Œå› ä¸ºå›¾åƒçš„è¾¹ç¼˜ç‚¹å¾ˆéš¾å®šä½ï¼ŒåŒæ—¶ä¹Ÿå®¹æ˜“å—åˆ°å™ªå£°çš„å¹²æ‰°.</p>
<p>ç‰©ä½“è¾¹ç¼˜ä½ç½®çš„ä¸€ä¸ªæ–¹å‘çš„ä¸»æ›²ç‡ä¼šæ¯”è¾ƒé«˜, è€Œè‰¯å¥½çš„è¾¹ç¼˜(æ¯”å¦‚æ³¡æ³¡), ä¸¤ä¸ªæ–¹å‘çš„æ›²ç‡éƒ½æ¯”è¾ƒé«˜. </p>
<p>è®ºæ–‡ä¸­ä½¿ç”¨æµ·æ£®çŸ©é˜µå¯¹æ›²ç‡è¿›è¡Œåˆ¤æ–­.å¯¹äºäºŒç»´å›¾åƒçš„æŸç‚¹çš„hessiançŸ©é˜µï¼Œå…¶æœ€å¤§ç‰¹å¾å€¼å’Œå…¶å¯¹åº”çš„ç‰¹å¾å‘é‡å¯¹åº”å…¶é‚»åŸŸäºŒç»´æ›²çº¿æœ€å¤§æ›²ç‡çš„å¼ºåº¦å’Œæ–¹å‘ï¼Œå³å±±å¡é™¡çš„é‚£é¢ï¼›æœ€å°ç‰¹å¾å€¼å¯¹åº”çš„ç‰¹å¾å‘é‡å¯¹åº”ä¸å…¶å‚ç›´çš„æ–¹å‘ï¼Œå³å¹³ç¼“çš„æ–¹å‘ã€‚
$$
H=\left[\begin{array}{2}D_{xx} &amp; D_{xy} \ D_{xy} &amp; D_{yy} \end{array}\right]
$$
ä»¤$\alpha$å’Œ$\beta$åˆ†åˆ«ä¸º$H$çš„æœ€å¤§æœ€å°ç‰¹å¾å€¼, å³xå’Œyæ–¹å‘çš„æ¢¯åº¦, åˆ™
$$
Tr(H)=\alpha + \beta \
Det(H)=\alpha\beta
$$
ä»¤$\alpha=r\beta$, åˆ™
$$
\frac{Tr(H)^2}{Det(H)}=\frac{(\alpha+\beta)^2}{\alpha\beta}=\frac{(r+1)^2}{r}
$$
ä¸Šå¼è¶Šå¤§, è¯´æ˜ä¸€ä¸ªæ–¹å‘çš„æ¢¯åº¦è¶Šå¤§, å¦ä¸€ä¸ªæ–¹å‘çš„æ¢¯åº¦è¶Šå°, å¯¹äºè¿™æ ·çš„ç‚¹éœ€è¦è¿›è¡Œå‰”é™¤. </p>
<p>åœ¨æ–‡ä¸­, å–é˜ˆå€¼$r=10$. </p>
<h4>æ–¹å‘åŒ¹é…</h4>
<p>ä¸ºä½¿å¾—æå–çš„ç‰¹å¾å¯¹æ—‹è½¬å…·æœ‰ä¸å˜æ€§, éœ€è¦ä¸ºæ¯ä¸ªå…³é”®ç‚¹åˆ†é…ä¸€ä¸ªåŸºå‡†æ–¹å‘. </p>
<p>è¯¥æ–¹å‘æ˜¯æ ¹æ®å…³é”®ç‚¹çš„å±€éƒ¨ç‰¹å¾è®¡ç®—å‡ºæ¥çš„. </p>
<p>å¯¹äºå…³é”®çš„é‚»åŸŸ, ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•è®¡ç®—æ¯ä¸ªç‚¹çš„æ¢¯åº¦æ¨¡å€¼å’Œæ–¹å‘.
$$
m(x,y) =\sqrt{(L(x+1,y)-L(x-1, y))^2 + (L(x, y+1)-L(x, y-1))^2}\
\theta(x,y)=\tan^{-1}\frac{L(x, y+1)-L(x, y-1)}{L(x+1, y)-L(x-1, y)}
$$
å…¶ä¸­é‚»åŸŸå¤§å°ä¸º$r=3\times1.5\sigma_c$, $\sigma_c$ä¸ºå½“å‰å±‚çš„å›¾åƒå°ºåº¦.</p>
<p>è®¡ç®—å, éœ€è¦å…ˆå¯¹æ¨¡å€¼è¿›è¡ŒåŠ æƒ, æƒå€¼ä¸º$\sigma_m=1.5\sigma_c$çš„é«˜æ–¯å‡½æ•°,</p>
<p>å¯¹åŠ æƒåçš„æ¨¡å€¼, ä½¿ç”¨ç›´æ–¹å›¾ç»Ÿè®¡é‚»åŸŸå†…çš„åƒç´ æ¢¯åº¦å’Œæ–¹å‘. ç›´æ–¹å›¾å°†360åº¦åˆ†ä¸º36ä¸ªbin, æ¯ä¸ªbinçš„å€¼ä¸ºè¯¥æ–¹å‘åŠ æƒåæ¨¡å€¼çš„å’Œ.</p>
<p>å–ç›´æ–¹å›¾æœ€é«˜æŸ±ä½œä¸ºè¯¥å…³é”®ç‚¹çš„ä¸»æ–¹å‘, æ»¡è¶³æœ€é«˜å€¼çš„80%ä½œä¸ºè¾…åŠ©æ–¹å‘.</p>
<h4>å…³é”®ç‚¹ç‰¹å¾æè¿°</h4>
<p>ä¸Šä¸€æ­¥è·å–äº†SIFTå…³é”®ç‚¹, åŠå…¶å°ºåº¦å’Œæ–¹å‘. æ¥ä¸‹æ¥ä¸ºæ¯ä¸ªå…³é”®ç‚¹å»ºç«‹æè¿°ç¬¦. ç”¨ä¸€ç»„å‘é‡æè¿°å…³é”®ç‚¹.</p>
<ul>
<li>å°†å…³é”®ç‚¹çš„é‚»åŸŸåˆ’åˆ†ä¸º$d\times d$ä¸ªåŒºåŸŸ, æ–‡ç« ä¸­å–$d=4$. è®¡ç®—8ä¸ªæ–¹å‘çš„æ¢¯åº¦ä¿¡æ¯, å…±$4\times 4\times 8=128$ç»´.</li>
<li>æ¯ä¸ªåŒºåŸŸçš„è¾¹é•¿ä¸º$\sigma_c$, å®é™…è®¡ç®—æ—¶ä½¿ç”¨åŒçº¿æ€§æ’å€¼, å–è¾¹é•¿ä¸º$3\sigma_c\times(d+1)$.</li>
<li>
<p>ä¸ºäº†ä¿è¯å…³é”®ç‚¹çš„æ–¹å‘ä¸å˜æ€§,éœ€è¦å¯¹ç‰¹å¾ç‚¹é‚»åŸŸè¿›è¡Œæ—‹è½¬, æ—‹è½¬è§’åº¦ä¸ºç‰¹å¾ç‚¹è§’åº¦. ä¸ºä½¿å¾—æ—‹è½¬åŒºåŸŸåŒ…å«æ­£æ–¹å½¢, å®é™…ä¸Šå¾—è¾¹é•¿ä¸º$\frac{3\sigma_c(d+1)\sqrt2}{2}$.</p>
</li>
<li>
<p>ç„¶åéœ€è¦å°†å…³é”®ç‚¹åŠå…¶é‚»åŸŸçš„åæ ‡è½´(x)æ—‹è½¬åˆ°å…³é”®ç‚¹çš„ä¸»æ–¹å‘</p>
</li>
<li>æ—‹è½¬åçš„é‡‡æ ·ç‚¹åæ ‡ä¸º$$\left(\begin{array}{1}x' \ y'\end{array}\right)=\left(\begin{array}{2} \cos\theta &amp; -\sin\theta \\sin\theta &amp; \cos\theta \end{array}\right)$$</li>
<li>å°†é‚»åŸŸåˆ†é…åˆ°å¯¹äºçš„å­åŒºåŸŸå†…</li>
<li>è®¡ç®—æ¢¯åº¦å€¼å’Œè§’åº¦, ç”Ÿæˆç›´æ–¹å›¾</li>
<li>ç±»ä¼¼æ–¹å‘åŒ¹é…, ä¹Ÿéœ€è¦æ¨¡å€¼çš„åŠ æƒ<ul>
<li>ç¬¬ä¸€æ¬¡åŠ æƒ, æ ¹æ®åƒç´ ç‚¹ä¸å…³é”®ç‚¹çš„è·ç¦», ä½¿ç”¨$\sigma=\frac{d^2}{2}$çš„é«˜æ–¯æ ¸åŠ æƒ</li>
<li>ç¬¬äºŒæ¬¡åŠ æƒ, æ ¹æ®åƒç´ ç‚¹ä¸å­åŒºåŸŸä¸­å¿ƒçš„è·ç¦», ä½¿ç”¨é«˜æ–¯åŠ æƒ</li>
</ul>
</li>
<li>å°†åŠ æƒåçš„æ¨¡å€¼åˆ†é…åˆ°8ä¸ªæ–¹å‘ä¸Š, è·å–ç›´æ–¹å›¾</li>
<li>å¯¹ç›´æ–¹å›¾è¿›è¡Œå½’ä¸€åŒ–å¤„ç†</li>
<li>æ¶ˆé™¤å‡åŒ€å…‰ç…§çš„å½±å“</li>
<li>ä½¿ç”¨é˜ˆå€¼(0.2)å¯¹å½’ä¸€åŒ–åçš„ç›´æ–¹å›¾,è®¾å®šä¸Šé™</li>
<li>æ¶ˆé™¤éå‡åŒ€å…‰ç…§çš„å½±å“</li>
</ul>
<h3>ä»£ç å®ç°</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">File: c:\Users\lomom\Documents\DL2019\Assignment\code\sift.py</span>
<span class="sd">Project: c:\Users\lomom\Documents\DL2019\Assignment\code</span>
<span class="sd">Created Date: Monday June 24th 2019</span>
<span class="sd">Author: Hang Li (hangli@stu.xmu.edu.cn)</span>
<span class="sd">-----</span>
<span class="sd">Last Modified: Monday, 24th June 2019 2:56:06 pm</span>
<span class="sd">Modified By:  Hang Li (hangli@stu.xmu.edu.cn)</span>
<span class="sd">-----</span>
<span class="sd">Copyright (c) 2019 Wormhole</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">ndi</span> 
<span class="kn">import</span> <span class="nn">scipy</span> 
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">filters</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">multiprocessing.pool</span> <span class="kn">import</span> <span class="n">ThreadPool</span><span class="p">,</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">transform</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">color</span>
<span class="kn">import</span> <span class="nn">cv2</span> <span class="c1"># ç”¨äºå¯¹æ¯”ç»“æœ</span>


<span class="k">class</span> <span class="nc">ScaleSpace</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å›¾åƒé‡‘å­—å¡”ç±»</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_oct</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">n_spo</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">img_w</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">img_h</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">sigma_min</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">delta_min</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;[summary]</span>

<span class="sd">        :param n_oct: å›¾åƒé‡‘å­—å¡”å±‚æ•°</span>
<span class="sd">        :type n_oct: int</span>
<span class="sd">        :param n_spo: å›¾åƒé‡‘å­—å¡”æ¯å±‚çš„å›¾åƒæ•°(æŒ‡æœ€ç»ˆæ¯å±‚çš„æå€¼ç‚¹å±‚æ•°)</span>
<span class="sd">        :type n_spo: int</span>
<span class="sd">        :param img_w: å›¾åƒå®½åº¦</span>
<span class="sd">        :type img_w: int</span>
<span class="sd">        :param img_h: å›¾åƒé«˜åº¦</span>
<span class="sd">        :type img_h: int</span>
<span class="sd">        :param sigma_min: æœ€ä½å±‚çš„sigma</span>
<span class="sd">        :type sigma_min: int</span>
<span class="sd">        :param delta_min: æœ€åº•å±‚(æ”¾å¤§2å€çš„)å›¾åƒçš„åƒç´ é—´è·(ç›¸å¯¹äºè¾“å…¥å›¾åƒ), defaults to 0.5</span>
<span class="sd">        :type delta_min: float, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_oct</span> <span class="o">=</span> <span class="n">n_oct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_spo</span> <span class="o">=</span> <span class="n">n_spo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_sca</span> <span class="o">=</span> <span class="n">n_spo</span> <span class="o">+</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_w</span> <span class="o">=</span> <span class="n">img_w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_h</span> <span class="o">=</span> <span class="n">img_h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_min</span> <span class="o">=</span> <span class="n">sigma_min</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltas</span> <span class="o">=</span> <span class="p">[</span><span class="n">delta_min</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_w</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_h</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1">#è®°å½•æ¯å±‚çš„é•¿å®½ï¼Œ ä»¥åŠåƒç´ é—´è·ï¼Œ ç”¨äºå®šä½ç‰¹å¾åœ¨åŸå›¾çš„ä½ç½®</span>
        <span class="k">for</span> <span class="n">o_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_oct</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltas</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># è®¡ç®—æ¯å±‚çš„sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_oct</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sca</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">o_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_oct</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">s_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sca</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="p">[</span><span class="n">o_idx</span><span class="p">,</span> <span class="n">s_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_min</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span><span class="p">(</span><span class="n">o_idx</span> <span class="o">+</span> <span class="n">s_idx</span> <span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sca</span><span class="p">))</span>

        <span class="c1"># åˆ›å»ºé‡‘å­—å¡”å­˜å‚¨ç©ºé—´</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">octave</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">o_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_oct</span><span class="p">):</span>
            <span class="n">current_layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sca</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hs</span><span class="p">[</span><span class="n">o_idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="p">[</span><span class="n">o_idx</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">octave</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_layer</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">add_img_to_octave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">oct_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">s_idx</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å‘å›¾åƒé‡‘å­—å¡”ä¸­åŠ å…¥å›¾ç‰‡</span>

<span class="sd">        :param oct_idx: å±‚ç´¢å¼•</span>
<span class="sd">        :type oct_idx: int</span>
<span class="sd">        :param s_idx: å±‚å†…ç´¢å¼•</span>
<span class="sd">        :type s_idx: int</span>
<span class="sd">        :param img: åŠ å…¥çš„å›¾åƒ</span>
<span class="sd">        :type img: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">oct_idx</span><span class="p">][</span><span class="n">s_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">img</span>

    <span class="k">def</span> <span class="nf">get_prev_octave_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_oct</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è·å–ä¸Šä¸€å±‚çš„å€’æ•°ç¬¬ä¸‰å¼ å›¾åƒ, ç”¨äºè®¡ç®—ä¸‹ä¸€å±‚</span>

<span class="sd">        :param current_oct: å½“å‰å±‚ç´¢å¼•</span>
<span class="sd">        :type current_oct: int</span>
<span class="sd">        :return: [description]</span>
<span class="sd">        :rtype: [type]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">current_oct</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">get_sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o_idx</span><span class="p">,</span> <span class="n">s_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="p">[</span><span class="n">o_idx</span><span class="p">,</span> <span class="n">s_idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_current_octave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">o_idx</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">DogSpace</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å·®åˆ†é«˜æ–¯é‡‘å­—å¡”</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gauss_spcae</span><span class="p">:</span> <span class="n">ScaleSpace</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä»é«˜æ–¯é‡‘å­—å¡”æ„å»ºå·®åˆ†é«˜æ–¯é‡‘å­—å¡”çš„ç»“æ„</span>

<span class="sd">        :param gauss_spcae: é«˜æ–¯é‡‘å­—å¡”å¯¹è±¡</span>
<span class="sd">        :type gauss_spcae: ScaleSpace</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_oct</span> <span class="o">=</span> <span class="n">gauss_spcae</span><span class="o">.</span><span class="n">n_oct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_sca</span> <span class="o">=</span> <span class="n">gauss_spcae</span><span class="o">.</span><span class="n">n_sca</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">gauss_spcae</span><span class="o">.</span><span class="n">hs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">gauss_spcae</span><span class="o">.</span><span class="n">ws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltas</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">gauss_spcae</span><span class="o">.</span><span class="n">deltas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">octave</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sca</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_oct</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sca</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">o_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_oct</span><span class="p">):</span>
            <span class="n">current_layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sca</span><span class="p">,</span> <span class="n">gauss_spcae</span><span class="o">.</span><span class="n">hs</span><span class="p">[</span><span class="n">o_idx</span><span class="p">],</span> <span class="n">gauss_spcae</span><span class="o">.</span><span class="n">ws</span><span class="p">[</span><span class="n">o_idx</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">s_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sca</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="p">[</span><span class="n">o_idx</span><span class="p">,</span> <span class="n">s_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">gauss_spcae</span><span class="o">.</span><span class="n">get_sigma</span><span class="p">(</span><span class="n">o_idx</span><span class="p">,</span> <span class="n">s_idx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_current_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>  <span class="n">o_idx</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">o_idx</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">layer</span>

<span class="k">class</span> <span class="nc">KeyPoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å…³é”®ç‚¹</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;        </span>
<span class="sd">        :param o: å±‚ç´¢å¼•</span>
<span class="sd">        :param s: å±‚å†…ç´¢å¼•</span>
<span class="sd">        :param h: å°ºåº¦ç©ºé—´è¡Œç´¢å¼•</span>
<span class="sd">        :type h: [type]</span>
<span class="sd">        :param w: å°ºåº¦ç©ºé—´åˆ—ç´¢å¼•</span>
<span class="sd">        :param x: å…³é”®ç‚¹åœ¨åŸå›¾ä¸­çš„x</span>
<span class="sd">        :param y: å…³é”®ç‚¹åœ¨åŸå›¾ä¸­çš„y</span>
<span class="sd">        :param sigma: å…³é”®ç‚¹æ‰€åœ¨å°ºåº¦çš„sigma</span>
<span class="sd">        :param value: å…³é”®ç‚¹çš„å€¼</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="n">o</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">init_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">):</span>
        <span class="c1"># self.hist = [0 for _ in range(n_bins)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">init_descr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_descr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_descr</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è¯»å–å›¾ç‰‡, å¦‚æœæ˜¯å½©è‰²å›¾åƒå°†å…¶è½¬ä¸ºç°åº¦å›¾</span>

<span class="sd">    :param img_path: å›¾ç‰‡è·¯å¾„</span>
<span class="sd">    :type img_path: str</span>
<span class="sd">    :raises ValueError: [description]</span>
<span class="sd">    :return: [description]</span>
<span class="sd">    :rtype: [type]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">img_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;image path not exist:</span><span class="si">{</span><span class="n">img_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># img = ndi.imread(img_path)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># å°†å½©è‰²å›¾åƒè½¬ä¸ºç°åº¦å›¾åƒ</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2989</span><span class="p">,</span> <span class="mf">0.5870</span><span class="p">,</span> <span class="mf">0.1140</span><span class="p">])</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">/</span> <span class="mf">255.</span>
    <span class="k">return</span> <span class="n">img</span>

<span class="k">def</span> <span class="nf">subsample_by2</span><span class="p">(</span><span class="n">img_in</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¯¹å›¾åƒä¸‹é‡‡æ ·ï¼Œ æ ¹æ®è®ºæ–‡ä¸­çš„æè¿°-every second pixel in each row and column</span>
<span class="sd">    è¿™é‡Œé€‰å–ä»ç¬¬äºŒä¸ªåƒç´ å¼€å§‹</span>

<span class="sd">    :param img_in: å¾…ä¸‹é‡‡æ ·å›¾åƒ</span>
<span class="sd">    :type img_in: np.ndarray</span>
<span class="sd">    :return: ä¸‹é‡‡æ ·åçš„å›¾åƒ</span>
<span class="sd">    :rtype: [type]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">img_in</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="c1">#-------------- ç‰¹å¾é‡‘å­—å¡”-------------</span>
<span class="k">def</span> <span class="nf">gaussian_scale_space</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sigma_in</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">sigma_min</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">n_oct</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">n_spo</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ„å»ºé«˜æ–¯é‡‘å­—å¡”</span>

<span class="sd">    :param img: è¾“å…¥å›¾åƒ</span>
<span class="sd">    :type img: np.ndarray</span>
<span class="sd">    :param sigma_in: è¾“å…¥å›¾åƒçš„sigma, defaults to 0.5</span>
<span class="sd">    :type sigma_in: float, optional</span>
<span class="sd">    :param sigma_min: æœ€åº•å±‚å›¾åƒçš„sigma, defaults to 0.8</span>
<span class="sd">    :type sigma_min: float, optional</span>
<span class="sd">    :param n_oct: é‡‘å­—å¡”å±‚æ•°, defaults to 8</span>
<span class="sd">    :type n_oct: int, optional</span>
<span class="sd">    :param n_spo: é‡‘å­—å¡”æ¯å±‚çš„å›¾åƒæ•°, defaults to 3</span>
<span class="sd">    :type n_spo: int, optional</span>
<span class="sd">    :return: [description]</span>
<span class="sd">    :rtype: [type]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">delta_min</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">g_scale</span> <span class="o">=</span> <span class="n">ScaleSpace</span><span class="p">(</span><span class="n">n_oct</span><span class="o">=</span><span class="n">n_oct</span><span class="p">,</span> <span class="n">n_spo</span><span class="o">=</span><span class="n">n_spo</span><span class="p">,</span> <span class="n">img_w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">img_h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">sigma_min</span><span class="o">=</span><span class="n">sigma_min</span><span class="p">)</span>
    <span class="c1"># k = 2 ** (1 / (n_spo + 3))</span>
    <span class="n">nSca</span> <span class="o">=</span> <span class="n">n_spo</span> <span class="o">+</span> <span class="mi">3</span>
    <span class="n">sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_oct</span><span class="p">,</span> <span class="n">nSca</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_oct</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nSca</span><span class="p">):</span>
            <span class="n">sigmas</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_min</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span><span class="p">(</span><span class="n">o</span> <span class="o">+</span> <span class="n">s</span> <span class="o">/</span><span class="p">(</span><span class="n">nSca</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">oct_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_oct</span><span class="p">):</span><span class="c1"># æ„å»ºæ¯ä¸€å±‚</span>

        <span class="k">if</span> <span class="n">oct_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># æ„å»ºç¬¬ä¸€å±‚</span>
            <span class="n">sigma_extra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_in</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">sigma_in</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">delta_min</span> 
            <span class="n">image_shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>   
            <span class="n">resize_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">image_shape</span><span class="p">]</span>
            <span class="c1"># å°ºå¯¸æ‰©å¤§2å€</span>
            <span class="c1"># seed_image = scipy.misc.imresize(img, resize_shape, interp=&#39;bilinear&#39;)</span>
            <span class="c1">#0: Nearest-neighbor</span>
            <span class="c1">#1: Bi-linear (default)</span>
            <span class="c1">#2: Bi-quadratic</span>
            <span class="c1">#3: Bi-cubic</span>
            <span class="c1">#4: Bi-quartic</span>
            <span class="c1">#5: Bi-quintic</span>
            <span class="n">seed_image</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">resize_shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">image_add_blur</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">seed_image</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_extra</span><span class="p">)</span>
            <span class="n">current_image</span> <span class="o">=</span> <span class="n">image_add_blur</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># æ„å»ºå…¶ä½™å±‚çš„ç¬¬ä¸€å¼ </span>
            <span class="n">img_prev</span> <span class="o">=</span> <span class="n">g_scale</span><span class="o">.</span><span class="n">get_prev_octave_img</span><span class="p">(</span><span class="n">oct_idx</span><span class="p">)</span>
            <span class="n">current_image</span> <span class="o">=</span> <span class="n">subsample_by2</span><span class="p">(</span><span class="n">img_prev</span><span class="p">)</span>

        <span class="c1"># æ·»åŠ æ¯å±‚çš„ç¬¬ä¸€å¼ å›¾åƒ</span>
        <span class="n">g_scale</span><span class="o">.</span><span class="n">add_img_to_octave</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">current_image</span><span class="p">,</span> <span class="n">oct_idx</span><span class="o">=</span><span class="n">oct_idx</span><span class="p">,</span> <span class="n">s_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">prev_img</span> <span class="o">=</span> <span class="n">current_image</span>
        <span class="k">for</span> <span class="n">s_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nSca</span><span class="p">):</span> <span class="c1"># æ„å»ºæ¯ä¸€å±‚çš„å‰©ä½™å›¾åƒ</span>
            <span class="n">prev_sigma</span> <span class="o">=</span> <span class="n">g_scale</span><span class="o">.</span><span class="n">get_sigma</span><span class="p">(</span><span class="n">oct_idx</span><span class="p">,</span> <span class="n">s_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">next_sigma</span> <span class="o">=</span> <span class="n">g_scale</span><span class="o">.</span><span class="n">get_sigma</span><span class="p">(</span><span class="n">oct_idx</span><span class="p">,</span> <span class="n">s_idx</span><span class="p">)</span>

            <span class="n">sigma_extra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">next_sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">prev_sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">current_image</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">prev_img</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_extra</span><span class="p">)</span>
            <span class="n">g_scale</span><span class="o">.</span><span class="n">add_img_to_octave</span><span class="p">(</span><span class="n">current_image</span><span class="p">,</span> <span class="n">oct_idx</span><span class="o">=</span><span class="n">oct_idx</span><span class="p">,</span> <span class="n">s_idx</span><span class="o">=</span><span class="n">s_idx</span><span class="p">)</span>
            <span class="n">prev_img</span> <span class="o">=</span> <span class="n">current_image</span>
    <span class="k">return</span> <span class="n">g_scale</span>

<span class="c1">#-------------- å·®åˆ†é«˜æ–¯é‡‘å­—å¡”-------------</span>
<span class="k">def</span> <span class="nf">scale_space_dog</span><span class="p">(</span><span class="n">g_scale_space</span><span class="p">:</span> <span class="n">ScaleSpace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä»é«˜æ–¯é‡‘å­—å¡”æ„å»ºå·®åˆ†é«˜æ–¯é‡‘å­—å¡”</span>

<span class="sd">    :param g_scale_space: é«˜æ–¯é‡‘å­—å¡”å¯¹è±¡</span>
<span class="sd">    :type g_scale_space: ScaleSpace</span>
<span class="sd">    :return: å·®åˆ†é«˜æ–¯é‡‘å­—å¡”</span>
<span class="sd">    :rtype: [type]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ä»é«˜æ–¯é‡‘å­—å¡”å¯¹è±¡æ„å»ºå·®åˆ†é«˜æ–¯é‡‘å­—å¡”</span>
    <span class="n">d_space</span> <span class="o">=</span> <span class="n">DogSpace</span><span class="p">(</span><span class="n">g_scale_space</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">o_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">g_scale_space</span><span class="o">.</span><span class="n">n_oct</span><span class="p">):</span>
        <span class="n">c_octave</span> <span class="o">=</span> <span class="n">g_scale_space</span><span class="o">.</span><span class="n">get_current_octave</span><span class="p">(</span><span class="n">o_idx</span><span class="p">)</span>
        <span class="n">dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">c_octave</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># è®¡ç®—å·®åˆ†</span>
        <span class="n">d_space</span><span class="o">.</span><span class="n">set_current_layer</span><span class="p">(</span><span class="n">dif</span><span class="p">,</span> <span class="n">o_idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">d_space</span>

<span class="c1">#-------------- å·®åˆ†é«˜æ–¯é‡‘å­—å¡” ç©ºé—´æå€¼-------------</span>
<span class="k">def</span> <span class="nf">is_local_maxmin</span><span class="p">(</span><span class="n">c_octave</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">nei_offset</span><span class="p">,):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æŸ¥æ‰¾3Dæ•°ç»„ä¸­çš„å±€éƒ¨æå¤§æå°å€¼</span>

<span class="sd">    :param c_octave: 3Dæ•°ç»„</span>
<span class="sd">    :type c_octave: np.array</span>
<span class="sd">    :param loc: å½“å‰æŸ¥æ‰¾ä½ç½®</span>
<span class="sd">    :type loc: [type]</span>
<span class="sd">    :param nei_offset: ç›¸é‚»åƒç´ ç‚¹çš„åç§»é‡</span>
<span class="sd">    :type nei_offset: [type]</span>
<span class="sd">    :return: æ˜¯å¦ä¸ºæå¤§æå°å€¼</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s_idx</span><span class="p">,</span><span class="n">h_idx</span><span class="p">,</span><span class="n">w_idx</span> <span class="o">=</span> <span class="n">loc</span>
    <span class="n">center_value</span> <span class="o">=</span> <span class="n">c_octave</span><span class="p">[</span><span class="n">s_idx</span><span class="p">,</span><span class="n">h_idx</span><span class="p">,</span><span class="n">w_idx</span><span class="p">]</span> <span class="c1"># å½“å‰å€¼</span>
    <span class="n">is_local_min</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># æŸ¥æ‰¾æ˜¯å¦ä¸ºæå°å€¼</span>
    <span class="k">for</span> <span class="n">each_offset</span> <span class="ow">in</span> <span class="n">nei_offset</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c_octave</span><span class="p">[</span>
            <span class="n">s_idx</span><span class="o">+</span><span class="n">each_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h_idx</span><span class="o">+</span><span class="n">each_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">w_idx</span><span class="o">+</span><span class="n">each_offset</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="p">]</span> <span class="o">&lt;=</span> <span class="n">center_value</span><span class="p">:</span>
            <span class="n">is_local_min</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>
    <span class="c1"># æŸ¥æ‰¾æ˜¯å¦ä¸ºæå¤§å€¼</span>
    <span class="n">is_local_max</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">is_local_min</span><span class="p">:</span>
        <span class="n">is_local_max</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">each_offset</span> <span class="ow">in</span> <span class="n">nei_offset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c_octave</span><span class="p">[</span>
                <span class="n">s_idx</span><span class="o">+</span><span class="n">each_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h_idx</span><span class="o">+</span><span class="n">each_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">w_idx</span><span class="o">+</span><span class="n">each_offset</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">&gt;=</span> <span class="n">center_value</span><span class="p">:</span>
                <span class="n">is_local_max</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">is_local_max</span> <span class="ow">or</span> <span class="n">is_local_min</span>

<span class="k">def</span> <span class="nf">keypoints_find_3d_discrete_extrema</span><span class="p">(</span><span class="n">dog_space</span><span class="p">:</span> <span class="n">DogSpace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä»å·®åˆ†é«˜æ–¯é‡‘å­—å¡”ä¸­æŸ¥æ‰¾å…³é”®ç‚¹</span>

<span class="sd">    :param dog_space: é«˜æ–¯é‡‘å­—å¡”å¯¹è±¡</span>
<span class="sd">    :type dog_space: DogSpace</span>
<span class="sd">    :return: å…³é”®ç‚¹</span>
<span class="sd">    :rtype: [type]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_oct</span> <span class="o">=</span> <span class="n">dog_space</span><span class="o">.</span><span class="n">n_oct</span>
    <span class="n">n_sca</span> <span class="o">=</span> <span class="n">dog_space</span><span class="o">.</span><span class="n">n_sca</span>
    <span class="c1"># åˆ›å»ºåç§»æ•°ç»„ï¼Œ æ–¹ä¾¿ä¸‹ä¸€æ­¥è®¡ç®—</span>
    <span class="n">nei_offset</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">w_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">s_idx</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">h_idx</span> <span class="o">!=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">w_idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nei_offset</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">s_idx</span><span class="p">,</span> <span class="n">h_idx</span><span class="p">,</span> <span class="n">w_idx</span><span class="p">))</span>

    <span class="n">key_points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">o_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_oct</span><span class="p">):</span> <span class="c1"># éå†é‡‘å­—å¡”çš„æ¯ä¸€å±‚</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">dog_space</span><span class="o">.</span><span class="n">ws</span><span class="p">[</span><span class="n">o_idx</span><span class="p">],</span> <span class="n">dog_space</span><span class="o">.</span><span class="n">hs</span><span class="p">[</span><span class="n">o_idx</span><span class="p">]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">dog_space</span><span class="o">.</span><span class="n">deltas</span><span class="p">[</span><span class="n">o_idx</span><span class="p">]</span>
        <span class="n">c_octave</span> <span class="o">=</span> <span class="n">dog_space</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">o_idx</span><span class="p">]</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_sca</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">h_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">w_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">locs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">s_idx</span><span class="p">,</span><span class="n">h_idx</span><span class="p">,</span><span class="n">w_idx</span><span class="p">))</span>
        <span class="c1"># ä½¿ç”¨è¿›ç¨‹æ± è®¡ç®—</span>
        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">as</span> <span class="n">tp</span><span class="p">:</span>
        <span class="c1"># with ThreadPool(16) as tp:</span>
            <span class="n">ret_flag</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">is_local_maxmin</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">c_octave</span><span class="p">),</span> <span class="n">locs</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">nei_offset</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">ret_flag</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">s_idx</span><span class="p">,</span> <span class="n">h_idx</span><span class="p">,</span> <span class="n">w_idx</span> <span class="o">=</span> <span class="n">loc</span>
                <span class="n">key_p</span> <span class="o">=</span> <span class="n">KeyPoint</span><span class="p">(</span> <span class="n">o_idx</span><span class="p">,</span> <span class="n">s_idx</span><span class="p">,</span> <span class="n">h_idx</span><span class="p">,</span> <span class="n">w_idx</span><span class="p">,</span>
                    <span class="n">delta</span> <span class="o">*</span> <span class="n">h_idx</span><span class="p">,</span> <span class="n">delta</span> <span class="o">*</span> <span class="n">w_idx</span><span class="p">,</span>
                    <span class="n">dog_space</span><span class="o">.</span><span class="n">sigmas</span><span class="p">[</span><span class="n">o_idx</span><span class="p">],</span>
                    <span class="n">c_octave</span><span class="p">[</span><span class="n">s_idx</span><span class="p">,</span> <span class="n">h_idx</span><span class="p">,</span> <span class="n">w_idx</span><span class="p">])</span>
                <span class="n">key_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key_p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">key_points</span>


<span class="c1">#-------------- å·®åˆ†é«˜æ–¯é‡‘å­—å¡” ç©ºé—´æå€¼ ç²¾ç¡®å®šä½-------------</span>
<span class="k">def</span> <span class="nf">keypoints_discard_with_low_response</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">thresh</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ç§»é™¤ä½å¯¹æ¯”åº¦çš„ç‚¹</span>

<span class="sd">    :param keys: å…³é”®ç‚¹åˆ—è¡¨</span>
<span class="sd">    :type keys: list</span>
<span class="sd">    :param thresh: é˜ˆå€¼</span>
<span class="sd">    :type thresh: float</span>
<span class="sd">    :return: å¤„ç†åçš„å…³é”®ç‚¹åˆ—è¡¨</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">each_key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">each_key</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">inverse_3D_Taylor</span><span class="p">(</span><span class="n">octave</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ³°å‹’å±•å¼€æ‹Ÿåˆ,æ±‚è§£(s,i,j)ä½ç½®é™„è¿‘æå€¼ç‚¹çš„åç§»é‡</span>
<span class="sd">    è®¡ç®—è¿‡ç¨‹ç”±æ³°å‹’å±•å¼€å¯¹Xæ±‚å¯¼å¹¶ä»¤å…¶ä¸º0,è·å¾—åç§»é‡</span>
<span class="sd">    éœ€è¦è®¡ç®—ä¸€é˜¶å¯¼æ•°, äºŒé˜¶å¯¼æ•°åŠäºŒé˜¶å¯¼æ•°çš„é€†</span>
<span class="sd">    ä½¿ç”¨æœ‰é™å·®åˆ†æ³•æ±‚å¯¼çš„æ–¹å¼è®¡ç®—è¯¥å¯¼æ•°</span>
<span class="sd">    æœ‰é™å·®åˆ†æ³•å‚è€ƒhttps://blog.csdn.net/zddblog/article/details/7521424 4.3æœ‰é™å·®åˆ†æ³•æ±‚å¯¼</span>

<span class="sd">    :param octave: å·®åˆ†é«˜æ–¯é‡‘å­—å¡”çš„ä¸€å±‚</span>
<span class="sd">    :type octave: np.ndarray</span>
<span class="sd">    :param s: å±‚å†…ç´¢å¼•</span>
<span class="sd">    :type s: [type]</span>
<span class="sd">    :param i: å±‚å†…è¡Œç´¢å¼•</span>
<span class="sd">    :type i: [type]</span>
<span class="sd">    :param j: å±‚å†…åˆ—ç´¢å¼•</span>
<span class="sd">    :type j: [type]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># åœ¨å·®åˆ†è¿‘ä¼¼ä¸­ï¼Œ åˆ†æ¯åŒ…å«hï¼Œ å› ä¸ºè¿™é‡Œh=1ï¼Œæ‰€ä»¥ç›´æ¥çœç•¥</span>
    <span class="c1"># è®¡ç®—ä¸€é˜¶åå¯¼</span>
    <span class="n">gx</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
    <span class="n">gy</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

    <span class="c1"># è®¡ç®—äºŒé˜¶åå¯¼</span>
    <span class="n">hxx</span> <span class="o">=</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="n">hyy</span> <span class="o">=</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="n">hss</span> <span class="o">=</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

    <span class="n">hxy</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">hxs</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
    <span class="n">hys</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>


    <span class="c1"># å¯¹äºŒé˜¶çŸ©é˜µæ±‚é€†</span>
    <span class="c1"># æµ·æ£®çŸ©é˜µçš„å½¢å¼å¦‚ä¸‹(åªå†™åˆ†æ¯)</span>
    <span class="c1"># | xx xy xs |</span>
    <span class="c1"># | yx yy ys |</span>
    <span class="c1"># | sx sy ss |</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">hxx</span><span class="o">*</span><span class="n">hyy</span><span class="o">*</span><span class="n">hss</span> <span class="o">-</span> <span class="n">hxx</span><span class="o">*</span><span class="n">hys</span><span class="o">*</span><span class="n">hys</span> <span class="o">-</span> <span class="n">hxy</span><span class="o">*</span><span class="n">hxy</span><span class="o">*</span><span class="n">hss</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">hxy</span><span class="o">*</span><span class="n">hxs</span><span class="o">*</span><span class="n">hys</span> <span class="o">-</span> <span class="n">hxs</span><span class="o">*</span><span class="n">hxs</span><span class="o">*</span><span class="n">hyy</span>
    <span class="c1"># if det == 0:</span>
    <span class="c1">#     return 5., 5., 5., 1</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="p">(</span><span class="n">hyy</span><span class="o">*</span><span class="n">hss</span> <span class="o">-</span> <span class="n">hys</span><span class="o">*</span><span class="n">hys</span><span class="p">)</span> <span class="o">/</span> <span class="n">det</span>
    <span class="n">ab</span> <span class="o">=</span> <span class="p">(</span><span class="n">hxs</span><span class="o">*</span><span class="n">hys</span> <span class="o">-</span> <span class="n">hxy</span><span class="o">*</span><span class="n">hss</span><span class="p">)</span> <span class="o">/</span> <span class="n">det</span>
    <span class="n">ac</span> <span class="o">=</span> <span class="p">(</span><span class="n">hxy</span><span class="o">*</span><span class="n">hys</span> <span class="o">-</span> <span class="n">hxs</span><span class="o">*</span><span class="n">hyy</span><span class="p">)</span> <span class="o">/</span> <span class="n">det</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="p">(</span><span class="n">hxx</span><span class="o">*</span><span class="n">hss</span> <span class="o">-</span> <span class="n">hxs</span><span class="o">*</span><span class="n">hxs</span><span class="p">)</span> <span class="o">/</span> <span class="n">det</span>
    <span class="n">bc</span> <span class="o">=</span> <span class="p">(</span><span class="n">hxy</span><span class="o">*</span><span class="n">hxs</span> <span class="o">-</span> <span class="n">hxx</span><span class="o">*</span><span class="n">hys</span><span class="p">)</span> <span class="o">/</span> <span class="n">det</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="p">(</span><span class="n">hxx</span><span class="o">*</span><span class="n">hyy</span> <span class="o">-</span> <span class="n">hxy</span><span class="o">*</span><span class="n">hxy</span><span class="p">)</span> <span class="o">/</span> <span class="n">det</span>

    <span class="c1"># åç§»é‡</span>
    <span class="c1"># æ ¹æ®è§£å‡ºçš„å…¬å¼ï¼Œåç§»é‡ä¸º3*3çš„é€†çŸ©é˜µä¹˜ä»¥3*1çš„ä¸€é˜¶åå¯¼åˆ—å‘é‡</span>
    <span class="c1"># æ‹†è§£çŸ©é˜µç›¸ä¹˜è¿ç®—</span>
    <span class="n">ofst_x</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">aa</span> <span class="o">*</span> <span class="n">gx</span> <span class="o">+</span> <span class="n">ab</span> <span class="o">*</span> <span class="n">gy</span> <span class="o">+</span> <span class="n">ac</span> <span class="o">*</span> <span class="n">gs</span><span class="p">)</span>
    <span class="n">ofst_y</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">ab</span> <span class="o">*</span> <span class="n">gx</span> <span class="o">+</span> <span class="n">bb</span> <span class="o">*</span> <span class="n">gy</span> <span class="o">+</span> <span class="n">bc</span> <span class="o">*</span> <span class="n">gs</span><span class="p">)</span>
    <span class="n">ofst_s</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">ac</span> <span class="o">*</span> <span class="n">gx</span> <span class="o">+</span> <span class="n">bc</span> <span class="o">*</span> <span class="n">gy</span> <span class="o">+</span> <span class="n">cc</span> <span class="o">*</span> <span class="n">gs</span><span class="p">)</span>

    <span class="c1"># æ’å€¼åçš„æå€¼çš„åç§»é‡</span>
    <span class="n">ofst_val</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">gx</span> <span class="o">*</span> <span class="n">ofst_x</span> <span class="o">+</span> <span class="n">gy</span> <span class="o">*</span> <span class="n">ofst_y</span> <span class="o">+</span> <span class="n">gs</span> <span class="o">*</span> <span class="n">ofst_s</span><span class="p">)</span>

    <span class="n">val</span> <span class="o">=</span> <span class="n">octave</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">ofst_val</span>

    <span class="k">return</span> <span class="n">ofst_s</span><span class="p">,</span> <span class="n">ofst_x</span><span class="p">,</span> <span class="n">ofst_y</span><span class="p">,</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">keypoints_interpolate_position</span><span class="p">(</span><span class="n">dog_space</span><span class="p">:</span> <span class="n">DogSpace</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">KeyPoint</span><span class="p">],</span> <span class="n">iter_max</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¯¹å…³é”®ç‚¹ä½ç½®è¿›è¡Œæ’å€¼ï¼Œè·å–æ›´ç²¾ç¡®çš„ä½ç½®</span>

<span class="sd">    :param dog_space: å·®åˆ†é«˜æ–¯é‡‘å­—å¡”</span>
<span class="sd">    :type dog_space: DogSpace</span>
<span class="sd">    :param keys: å…³é”®ç‚¹åˆ—è¡¨</span>
<span class="sd">    :type keys: List[KeyPoint]</span>
<span class="sd">    :param iter_max: æœ€å¤§è¿­ä»£æ¬¡æ•°</span>
<span class="sd">    :type iter_max: int</span>
<span class="sd">    :return: ç­›é€‰åçš„å…³é”®ç‚¹</span>
<span class="sd">    :rtype: [type]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_inter</span> <span class="o">=</span> <span class="n">iter_max</span> <span class="c1"># æœ€å¤§æ’å€¼æ¬¡æ•°</span>
    <span class="n">ofst_max</span> <span class="o">=</span> <span class="mf">0.6</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sigma_ratio</span> <span class="o">=</span> <span class="n">dog_space</span><span class="o">.</span><span class="n">sigmas</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">dog_space</span><span class="o">.</span><span class="n">sigmas</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span> <span class="c1"># è¿­ä»£æ‰€æœ‰çš„å…³é”®ç‚¹</span>
        <span class="n">o</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">w</span>

        <span class="n">octave</span> <span class="o">=</span> <span class="n">dog_space</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">dog_space</span><span class="o">.</span><span class="n">ws</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">dog_space</span><span class="o">.</span><span class="n">hs</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">dog_space</span><span class="o">.</span><span class="n">n_sca</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">dog_space</span><span class="o">.</span><span class="n">deltas</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># å¼€å§‹æ’å€¼</span>
        <span class="n">c_i</span><span class="p">,</span> <span class="n">c_j</span><span class="p">,</span> <span class="n">c_s</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">s</span>
        <span class="n">n_intrp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">is_conv</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">ofst_x</span><span class="p">,</span> <span class="n">ofst_y</span><span class="p">,</span> <span class="n">ofst_s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">n_intrp</span> <span class="o">&lt;</span> <span class="n">max_inter</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">c_i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">c_j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">ofst_s</span><span class="p">,</span> <span class="n">ofst_y</span><span class="p">,</span> <span class="n">ofst_s</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">inverse_3D_Taylor</span><span class="p">(</span><span class="n">octave</span><span class="p">,</span> <span class="n">c_s</span><span class="p">,</span> <span class="n">c_i</span><span class="p">,</span> <span class="n">c_j</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_conv</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">ofst_x</span><span class="o">=</span><span class="mf">5.0</span>
                <span class="n">ofst_y</span><span class="o">=</span><span class="mf">5.0</span>
                <span class="n">ofst_s</span><span class="o">=</span><span class="mf">5.0</span>

            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ofst_x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ofst_max</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ofst_y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ofst_max</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ofst_s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ofst_max</span><span class="p">:</span>
                <span class="n">is_conv</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ofst_x</span> <span class="o">&gt;</span> <span class="n">ofst_max</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">c_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
                    <span class="n">c_i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ofst_x</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">ofst_max</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">c_i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">c_i</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ofst_y</span> <span class="o">&gt;</span> <span class="n">ofst_max</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">c_j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
                    <span class="n">c_j</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ofst_y</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">ofst_max</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">c_j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">c_j</span> <span class="o">-=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">ofst_s</span> <span class="o">&gt;</span> <span class="n">ofst_max</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">c_s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ns</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
                    <span class="n">c_s</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ofst_s</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">ofst_max</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">c_s</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">c_s</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="n">n_intrp</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">is_conv</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dog_space</span><span class="o">.</span><span class="n">sigmas</span><span class="p">[</span><span class="n">o</span><span class="p">,</span> <span class="n">c_s</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigma_ratio</span><span class="o">**</span><span class="n">ofst_s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sigma is zero&#39;</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">KeyPoint</span><span class="p">(</span>
                <span class="n">o</span><span class="o">=</span><span class="n">o</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">c_s</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">c_i</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">c_j</span><span class="p">,</span> 
                <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">c_i</span><span class="o">+</span><span class="n">ofst_x</span><span class="p">)</span><span class="o">*</span><span class="n">delta</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="n">c_j</span><span class="o">+</span><span class="n">ofst_max</span><span class="p">)</span><span class="o">*</span><span class="n">delta</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">dog_space</span><span class="o">.</span><span class="n">sigmas</span><span class="p">[</span><span class="n">o</span><span class="p">,</span> <span class="n">c_s</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigma_ratio</span><span class="o">**</span><span class="n">ofst_s</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">val</span>
                <span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">keypoints_edge_response</span><span class="p">(</span><span class="n">dog_sp</span><span class="p">:</span> <span class="n">DogSpace</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">KeyPoint</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è®¡ç®—å…³é”®ç‚¹çš„è¾¹ç¼˜å“åº”</span>

<span class="sd">    :param dog_sp: å·®åˆ†é«˜æ–¯é‡‘å­—å¡”</span>
<span class="sd">    :type dog_sp: DogSpace</span>
<span class="sd">    :param keys: å…³é”®ç‚¹åˆ—è¡¨</span>
<span class="sd">    :type keys: List[KeyPoint]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">o</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">w</span>
        <span class="n">c_img</span> <span class="o">=</span> <span class="n">dog_sp</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">dog_sp</span><span class="o">.</span><span class="n">ws</span><span class="p">[</span><span class="n">o</span><span class="p">],</span> <span class="n">dog_sp</span><span class="o">.</span><span class="n">hs</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>

        <span class="c1"># è®¡ç®—äºŒé˜¶æµ·æ£®çŸ©é˜µ</span>
        <span class="n">hxx</span> <span class="o">=</span> <span class="n">c_img</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">c_img</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">c_img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">hyy</span> <span class="o">=</span> <span class="n">c_img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c_img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">c_img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">hxy</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">c_img</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c_img</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">c_img</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">c_img</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">edge_response</span> <span class="o">=</span> <span class="p">(</span><span class="n">hxx</span> <span class="o">+</span> <span class="n">hyy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">hxx</span><span class="o">*</span><span class="n">hyy</span> <span class="o">-</span> <span class="n">hxy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">key</span><span class="o">.</span><span class="n">edge_resp</span> <span class="o">=</span>  <span class="n">edge_response</span>


<span class="k">def</span> <span class="nf">keypoints_discard_with_edge_resp</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">KeyPoint</span><span class="p">],</span> <span class="n">thresh</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ ¹æ®å…³é”®ç‚¹çš„è¾¹ç¼˜å“åº”å‰”é™¤å“åº”è¾ƒå¼±çš„ç‚¹</span>

<span class="sd">    :param keys: å…³é”®ç‚¹åˆ—è¡¨</span>
<span class="sd">    :type keys: List[KeyPoint]</span>
<span class="sd">    :param thresh: å“åº”é˜ˆå€¼</span>
<span class="sd">    :type thresh: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">edge_resp</span> <span class="o">&lt;=</span> <span class="n">thresh</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ret</span>




<span class="c1">#--------------æ–¹å‘åŒ¹é…-------------</span>
<span class="k">def</span> <span class="nf">compute_gradient</span><span class="p">(</span><span class="n">im</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>

    <span class="c1"># è®¡ç®—dy</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">dy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="c1"># å¤„ç†è¾¹ç•Œ</span>
        <span class="n">dy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">dy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># è®¡ç®—dx</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="n">dx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="n">dx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">dx</span><span class="p">[</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">im</span><span class="p">[</span><span class="n">h</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span>

<span class="k">def</span> <span class="nf">scale_compute_gradient</span><span class="p">(</span><span class="n">g_scale_space</span><span class="p">:</span> <span class="n">ScaleSpace</span><span class="p">,</span> <span class="n">dx_space</span><span class="p">:</span> <span class="n">ScaleSpace</span><span class="p">,</span> <span class="n">dy_space</span><span class="p">:</span> <span class="n">ScaleSpace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;é¢„å…ˆè®¡ç®—ä¸¤ä¸ªæ–¹å‘çš„å·®åˆ†ï¼Œ é¿å…åœ¨åç»­è®¡ç®—ä¸­é‡å¤è®¡ç®—å·®åˆ†</span>

<span class="sd">    :param g_scale_space: é«˜æ–¯é‡‘å­—å¡”</span>
<span class="sd">    :type g_scale_space: ScaleSpace</span>
<span class="sd">    :param dx_space: xæ–¹å‘å·®åˆ†é‡‘å­—å¡”</span>
<span class="sd">    :type dx_space: ScaleSpace</span>
<span class="sd">    :param dy_space: yæ–¹å‘å·®åˆ†é‡‘å­—å¡”</span>
<span class="sd">    :type dy_space: ScaleSpace</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_oct</span> <span class="o">=</span> <span class="n">g_scale_space</span><span class="o">.</span><span class="n">n_oct</span>
    <span class="n">n_sca</span> <span class="o">=</span> <span class="n">g_scale_space</span><span class="o">.</span><span class="n">n_sca</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_oct</span><span class="p">):</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">g_scale_space</span><span class="o">.</span><span class="n">ws</span><span class="p">[</span><span class="n">o</span><span class="p">],</span> <span class="n">g_scale_space</span><span class="o">.</span><span class="n">hs</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sca</span><span class="p">):</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">g_scale_space</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">s</span><span class="p">,:,:]</span>
            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">compute_gradient</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
            <span class="n">dx_space</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dx</span>
            <span class="n">dy_space</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dy</span>

<span class="k">def</span> <span class="nf">accumulate_orientation_hist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">im_dx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">im_dy</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">lambda_ori</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">KeyPoint</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è®¡ç®—å…³é”®ç‚¹çš„æ–¹å‘ç›´æ–¹å›¾</span>

<span class="sd">    :param x: å½“å‰å°ºåº¦çš„x</span>
<span class="sd">    :type x: [type]</span>
<span class="sd">    :param y: å½“å‰å°ºåº¦çš„y</span>
<span class="sd">    :type y: [type]</span>
<span class="sd">    :param sigma: åŸå›¾å°ºåº¦çš„sigma</span>
<span class="sd">    :type sigma: [type]</span>
<span class="sd">    :param im_dx: xæ–¹å‘çš„å·®åˆ†å›¾åƒ</span>
<span class="sd">    :type im_dx: np.ndarray</span>
<span class="sd">    :param im_dy: yæ–¹å‘çš„å·®åˆ†å›¾åƒ</span>
<span class="sd">    :type im_dy: np.ndarray</span>
<span class="sd">    :param n_bins: æ–¹å‘ç›´æ–¹å›¾çš„binsæ•°é‡</span>
<span class="sd">    :type n_bins: [type]</span>
<span class="sd">    :param lambda_ori: ç”¨äºè®¡ç®—å–æ ·åŒºåŸŸå¤§å°çš„ç³»æ•°</span>
<span class="sd">    :type lambda_ori: float</span>
<span class="sd">    :param key: å…³é”®ç‚¹</span>
<span class="sd">    :type key: KeyPoint</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">im_dx</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">lambda_ori</span> <span class="o">*</span> <span class="n">sigma</span> <span class="c1"># è®¡ç®—å–æ ·åŠå¾„</span>

    <span class="c1"># è®¡ç®—å–æ ·åŒºåŸŸ</span>
    <span class="n">si_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">R</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">sj_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">R</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>

    <span class="n">si_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">R</span><span class="o">+</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sj_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">R</span><span class="o">+</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">si_min</span><span class="p">,</span> <span class="n">si_max</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sj_min</span><span class="p">,</span> <span class="n">sj_max</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="p">(</span><span class="n">si</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span>
            <span class="n">sy</span> <span class="o">=</span> <span class="p">(</span><span class="n">sj</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span>

            <span class="n">dx</span> <span class="o">=</span> <span class="n">im_dx</span><span class="p">[</span><span class="n">si</span><span class="p">,</span> <span class="n">sj</span><span class="p">]</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">im_dy</span><span class="p">[</span><span class="n">si</span><span class="p">,</span> <span class="n">sj</span><span class="p">]</span>

            <span class="c1"># è®¡ç®—è§’åº¦</span>
            <span class="n">ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

            <span class="c1"># è®¡ç®—åŠ æƒæƒå€¼</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">sx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">sy</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">lambda_ori</span><span class="o">*</span><span class="n">lambda_ori</span><span class="p">))</span>
            <span class="n">bin_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ori</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_bins</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">%</span> <span class="n">n_bins</span>

            <span class="n">key</span><span class="o">.</span><span class="n">hist</span><span class="p">[</span><span class="n">bin_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span>

    <span class="c1"># max_hist_idx = np.argmax(key.hist)</span>

    <span class="c1"># # å¯¹æ¢¯åº¦æ–¹å‘ç›´æ–¹å›¾è¿›è¡Œæ’å€¼ï¼Œ è·å–æ›´ç²¾ç¡®çš„æ–¹å‘</span>
    <span class="c1"># idx_prev = (max_hist_idx - 1 + n_bins) % n_bins</span>
    <span class="c1"># idx_next = (max_hist_idx + 1) % n_bins</span>

    <span class="c1"># h1 = key.hist[idx_prev]</span>
    <span class="c1"># h2 = key.hist[max_hist_idx]</span>
    <span class="c1"># h3 = key.hist[idx_next]</span>
    <span class="c1"># offset = (h3 - h1) / (2 * (h1 + h3 - 2*h2))</span>

    <span class="c1"># # è®¡ç®—æ’å€¼åçš„è§’åº¦ï¼Œ ä¿å­˜åˆ°å…³é”®ç‚¹ä¸­</span>
    <span class="c1"># new_ori = (max_hist_idx + 0.5 + offset) * (2 * np.pi / n_bins)</span>

    <span class="c1"># new_ori = new_ori - 2*np.pi if new_ori &gt; 2*np.pi else new_ori # å¤„ç†è¶Šç•Œæƒ…å†µ</span>
    <span class="c1"># key.theta = new_ori</span>

<span class="k">def</span> <span class="nf">smooth_hist</span><span class="p">(</span><span class="n">hist</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n_inter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¯¹è§’åº¦ç›´æ–¹å›¾è¿›è¡Œå¹³æ»‘</span>

<span class="sd">    :param hist: ç›´æ–¹å›¾</span>
<span class="sd">    :type hist: np.ndarray</span>
<span class="sd">    :param n_inter: å¹³æ»‘æ¬¡æ•°</span>
<span class="sd">    :type n_inter: [type]</span>
<span class="sd">    :return: å¹³æ»‘åçš„ç›´æ–¹å›¾</span>
<span class="sd">    :rtype: [type]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_inter</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bins</span><span class="p">):</span>
            <span class="n">i_prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">bins</span><span class="p">)</span> <span class="o">%</span> <span class="n">bins</span>
            <span class="n">i_next</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">bins</span>
            <span class="n">hist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">i_prev</span><span class="p">]</span><span class="o">+</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">tmp</span><span class="p">[</span><span class="n">i_next</span><span class="p">])</span><span class="o">/</span><span class="mf">3.</span>
    <span class="k">return</span> <span class="n">hist</span>

<span class="k">def</span> <span class="nf">interp_peak</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¯¹ç›´æ–¹å›¾æ–¹å‘è¿›è¡Œæ’å€¼</span>

<span class="sd">    :param h1: [description]</span>
<span class="sd">    :type h1: [type]</span>
<span class="sd">    :param h2: [description]</span>
<span class="sd">    :type h2: [type]</span>
<span class="sd">    :param h3: [description]</span>
<span class="sd">    :type h3: [type]</span>
<span class="sd">    :return: [description]</span>
<span class="sd">    :rtype: [type]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">h3</span> <span class="o">-</span> <span class="n">h1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">h1</span> <span class="o">+</span> <span class="n">h3</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">h2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">offset</span>

<span class="k">def</span> <span class="nf">extract_principal_ori</span><span class="p">(</span><span class="n">hist</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä»ç›´æ–¹å›¾ä¸­æå–ä¸»è¦æ–¹å‘å’Œè¾…åŠ©æ–¹å‘</span>

<span class="sd">    :param hist: è§’åº¦ç›´æ–¹å›¾</span>
<span class="sd">    :type hist: np.ndarray</span>
<span class="sd">    :param thresh: è¾…åŠ©æ–¹å‘çš„é˜ˆå€¼:0~1</span>
<span class="sd">    :type thresh: [type]</span>
<span class="sd">    :return: æå–åçš„æ–¹å‘</span>
<span class="sd">    :rtype: [type]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">principal_ori</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
    <span class="n">smoothed_hist</span> <span class="o">=</span> <span class="n">smooth_hist</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

    <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">smoothed_hist</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bins</span><span class="p">):</span>
        <span class="n">i_prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">n_bins</span><span class="p">)</span> <span class="o">%</span> <span class="n">n_bins</span>
        <span class="n">i_next</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n_bins</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">smoothed_hist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thresh</span> <span class="o">*</span> <span class="n">max_val</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">smoothed_hist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">smoothed_hist</span><span class="p">[</span><span class="n">i_prev</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">smoothed_hist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">smoothed_hist</span><span class="p">[</span><span class="n">i_next</span><span class="p">]):</span>
            <span class="c1"># is peak</span>
            <span class="c1"># æ’å€¼</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">interp_peak</span><span class="p">(</span><span class="n">smoothed_hist</span><span class="p">[</span><span class="n">i_prev</span><span class="p">],</span> <span class="n">smoothed_hist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">smoothed_hist</span><span class="p">[</span><span class="n">i_next</span><span class="p">])</span>
            <span class="c1"># è®¡ç®—æ’å€¼åçš„è§’åº¦ï¼Œ ä¿å­˜åˆ°å…³é”®ç‚¹ä¸­</span>
            <span class="n">new_ori</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">n_bins</span><span class="p">)</span>
            <span class="n">new_ori</span> <span class="o">=</span> <span class="n">new_ori</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">if</span> <span class="n">new_ori</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">else</span> <span class="n">new_ori</span> <span class="c1"># å¤„ç†è¶Šç•Œæƒ…å†µ</span>
            <span class="n">principal_ori</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_ori</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">principal_ori</span>


<span class="k">def</span> <span class="nf">keypoints_attribute_orientations</span><span class="p">(</span><span class="n">sx</span><span class="p">:</span> <span class="n">ScaleSpace</span><span class="p">,</span> <span class="n">sy</span><span class="p">:</span> <span class="n">ScaleSpace</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">KeyPoint</span><span class="p">],</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">lambda_ori</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æå–å…³é”®ç‚¹ä¸»æ–¹å‘ä¿¡æ¯</span>

<span class="sd">    :param sx: xæ–¹å‘å·®åˆ†é«˜æ–¯é‡‘å­—å¡”</span>
<span class="sd">    :type sx: ScaleSpace</span>
<span class="sd">    :param sy: yæ–¹å‘å·®åˆ†é«˜æ–¯é‡‘å­—å¡”</span>
<span class="sd">    :type sy: ScaleSpace</span>
<span class="sd">    :param keys: å…³é”®ç‚¹åˆ—è¡¨</span>
<span class="sd">    :type keys: List[KeyPoint]</span>
<span class="sd">    :param n_bins: ä¿å­˜çš„æ–¹å‘æ•°ç›®, defaults to 36</span>
<span class="sd">    :type n_bins: int, optional</span>
<span class="sd">    :param lambda_ori: å¯¹æ¨¡å€¼åŠ æƒæ—¶é«˜æ–¯å‡½æ•°sigmaçš„ç³»æ•°, defaults to 3</span>
<span class="sd">    :type lambda_ori: int, optional</span>
<span class="sd">    :param t: è¾…åŠ©æ–¹å‘çš„ç›´æ–¹å›¾é˜ˆå€¼, defaults to 0.8</span>
<span class="sd">    :type t: int, optional</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">y</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">sigma</span>
        <span class="n">o</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">s</span>

        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">ws</span><span class="p">[</span><span class="n">o</span><span class="p">],</span> <span class="n">sx</span><span class="o">.</span><span class="n">hs</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>

        <span class="n">delta</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">deltas</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="c1"># å°†åæ ‡è½¬ä¸ºç‰¹å¾é‡‘å­—å¡”å¯¹åº”å±‚çš„åæ ‡</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">delta</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">delta</span>


        <span class="c1"># åŸå›¾å¯¹åº”å±‚çš„sigma</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">delta</span> 

        <span class="n">key</span><span class="o">.</span><span class="n">init_hist</span><span class="p">(</span><span class="n">n_bins</span><span class="p">)</span> <span class="c1"># åˆå§‹åŒ–å…³é”®ç‚¹çš„ç›´æ–¹å›¾</span>
        <span class="c1"># è®¡ç®—å…³é”®ç‚¹çš„æ–¹å‘ç›´æ–¹å›¾</span>
        <span class="n">accumulate_orientation_hist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">lambda_ori</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="c1"># æå–å…³é”®ç‚¹çš„å¤šä¸ªæ–¹å‘</span>
        <span class="n">prin_ori</span> <span class="o">=</span> <span class="n">extract_principal_ori</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">hist</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

        <span class="c1"># æŠŠè¯¥å…³é”®ç‚¹å¤åˆ¶æˆå¤šä»½å…³é”®ç‚¹ï¼Œå¹¶å°†æ–¹å‘å€¼åˆ†åˆ«èµ‹ç»™è¿™äº›å¤åˆ¶åçš„å…³é”®ç‚¹</span>
        <span class="k">for</span> <span class="n">ori</span> <span class="ow">in</span> <span class="n">prin_ori</span><span class="p">:</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">new_key</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">ori</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_key</span><span class="p">)</span>

    <span class="c1"># è¿”å›åˆ†é…äº†æ–¹å‘çš„å…³é”®ç‚¹</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="c1">#--------------å…³é”®ç‚¹ç‰¹å¾æè¿°-------------</span>
<span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å°†x y ç‚¹æ—‹è½¬theta</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">rx</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">s</span> <span class="o">*</span> <span class="n">y</span>
    <span class="n">ry</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="n">y</span>
    <span class="k">return</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span>

<span class="k">def</span> <span class="nf">extract_sift_feature_vector</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">im_dx</span><span class="p">,</span> <span class="n">im_dy</span><span class="p">,</span> <span class="n">n_hist</span><span class="p">,</span> <span class="n">n_ori</span><span class="p">,</span> <span class="n">lambda_descr</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span><span class="n">KeyPoint</span><span class="p">):</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">im_dx</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">n_hist</span><span class="p">)</span> <span class="o">*</span> <span class="n">lambda_descr</span> <span class="o">*</span> <span class="n">sigma</span>
    <span class="c1"># è€ƒè™‘æ—‹è½¬å› ç´ ï¼Œ å®é™…åŠå¾„éœ€è¦å†ä¹˜æ ¹å·2</span>
    <span class="n">Rp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">R</span>

    <span class="n">si_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">Rp</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">sj_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">Rp</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>

    <span class="n">si_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">Rp</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sj_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">Rp</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># éå†å…³é”®ç‚¹çš„é‚»åŸŸ</span>
    <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">si_min</span><span class="p">,</span> <span class="n">si_max</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sj_min</span> <span class="p">,</span> <span class="n">sj_max</span><span class="p">):</span>
            <span class="c1"># å½“å‰ç‚¹ç›¸å¯¹äºå…³é”®ç‚¹çš„åæ ‡</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">si</span> <span class="o">-</span> <span class="n">x</span>
            <span class="n">sy</span> <span class="o">=</span> <span class="n">sj</span> <span class="o">-</span> <span class="n">y</span>
            <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="o">-</span><span class="n">theta</span><span class="p">)</span> <span class="c1"># å°†å…³é”®ç‚¹æ–¹å‘ä¸åæ ‡è½´å¯¹é½</span>

            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sx</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sy</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">R</span><span class="p">:</span> <span class="c1"># åªå¤„ç†åŒºåŸŸå†…çš„ç‚¹</span>
                <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">im_dx</span><span class="p">[</span><span class="n">si</span><span class="p">,</span> <span class="n">sj</span><span class="p">],</span> <span class="n">im_dy</span><span class="p">[</span><span class="n">si</span><span class="p">,</span> <span class="n">sj</span><span class="p">]</span>

                <span class="n">ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span> <span class="o">-</span> <span class="n">theta</span> <span class="c1"># si sjç‚¹åœ¨æ—‹è½¬åçš„è§’åº¦</span>
                <span class="n">ori</span> <span class="o">=</span> <span class="p">(</span><span class="n">ori</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

                <span class="c1"># è®¡ç®—æ¢¯åº¦å¹…å€¼çš„åŠ æƒ</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">lambda_descr</span> <span class="o">*</span> <span class="n">sigma</span>
                <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">sx</span><span class="o">*</span><span class="n">sx</span><span class="o">+</span><span class="n">sy</span><span class="o">*</span><span class="n">sy</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

                <span class="c1"># alpha beta æŒ‡å‘å½“å‰çš„è®¡ç®—æ˜¯å“ªä¸ªbinçš„ä¸­å¿ƒ</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">sx</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lambda_descr</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">/</span><span class="n">n_hist</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_hist</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">beta</span>  <span class="o">=</span> <span class="n">sy</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lambda_descr</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">/</span><span class="n">n_hist</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_hist</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">gamma</span> <span class="o">=</span> <span class="n">ori</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_ori</span>

                <span class="n">i0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
                <span class="n">j0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i0</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">i0</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_hist</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">j0</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">j0</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_hist</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="c1"># å½“å‰æŒ‡å‘çš„æ–¹å‘bin</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_ori</span><span class="p">)</span> <span class="o">%</span> <span class="n">n_ori</span>

                        <span class="c1"># æ’å€¼å¤„ç†</span>
                        <span class="c1"># æ–¹å‘æŒ‡å‘æ˜¯è¿ç»­çš„ï¼Œå¯¹ç›¸é‚»çš„ä¸¤ä¸ªbinéƒ½æœ‰è´¡çŒ®ï¼Œé€šè¿‡æƒå€¼å¹³è¡¡</span>
                        <span class="c1"># é è¿‘å­åŒºåŸŸä¸­å¿ƒçš„æƒå€¼åº”è¯¥æ›´å¤§</span>

                        <span class="c1"># å¯¹å½“å‰æ–¹å‘çš„è´¡çŒ®åº¦</span>
                        <span class="n">key</span><span class="o">.</span><span class="n">descr</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">n_hist</span><span class="o">*</span><span class="n">n_ori</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">n_ori</span><span class="o">+</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">M</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">gamma</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">beta</span><span class="p">))</span>

                        <span class="c1"># å¯¹ç›¸é‚»æ–¹å‘çš„è´¡çŒ®åº¦</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">n_ori</span><span class="p">)</span> <span class="o">%</span> <span class="n">n_ori</span>
                        <span class="n">key</span><span class="o">.</span><span class="n">descr</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">n_hist</span><span class="o">*</span><span class="n">n_ori</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">n_ori</span><span class="o">+</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">M</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">beta</span><span class="p">))</span>



<span class="k">def</span> <span class="nf">threshold_quantize_feature_vector</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="n">KeyPoint</span><span class="p">,</span> <span class="n">n_descr</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
    <span class="n">l2_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">descr</span><span class="p">)</span>
    <span class="n">t_descr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">descr</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">*</span> <span class="n">l2_norm</span><span class="p">)</span>

    <span class="n">l2_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t_descr</span><span class="p">)</span>
    <span class="n">t_descr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">t_descr</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">/</span> <span class="n">l2_norm</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">key</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="n">t_descr</span>

<span class="k">def</span> <span class="nf">keypoints_attribute_descriptors</span><span class="p">(</span>
    <span class="n">im_dx</span><span class="p">:</span> <span class="n">ScaleSpace</span><span class="p">,</span> <span class="n">im_dy</span><span class="p">:</span> <span class="n">ScaleSpace</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">KeyPoint</span><span class="p">],</span>
    <span class="n">n_hist</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">n_ori</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span>
    <span class="n">lambda_descr</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ç”ŸæˆSIFTæè¿°å­</span>

<span class="sd">    :param im_dx: xæ–¹å‘å·®åˆ†é‡‘å­—å¡”</span>
<span class="sd">    :type im_dx: ScaleSpace</span>
<span class="sd">    :param im_dy: yæ–¹å‘å·®åˆ†é‡‘å­—å¡”</span>
<span class="sd">    :type im_dy: ScaleSpace</span>
<span class="sd">    :param keys: å…³é”®ç‚¹åˆ—è¡¨</span>
<span class="sd">    :type keys: List[KeyPoint]</span>
<span class="sd">    :param n_hist: ç›´æ–¹å›¾åˆ’åˆ†åŒºåŸŸæ•°ç›®</span>
<span class="sd">    :type n_hist: int</span>
<span class="sd">    :param n_ori: æ–¹å‘å–æ ·æ•°ç›®</span>
<span class="sd">    :type n_ori: int</span>
<span class="sd">    :param lambda_descr: æè¿°åŒºåŸŸåŠå¾„ç³»æ•°</span>
<span class="sd">    :type lambda_descr: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_descr</span> <span class="o">=</span> <span class="n">n_hist</span> <span class="o">*</span> <span class="n">n_hist</span> <span class="o">*</span> <span class="n">n_ori</span> <span class="c1"># æè¿°å­å‘é‡çš„å¤§å°</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>

        <span class="c1"># è·å–å…³é”®ç‚¹çš„å°ºåº¦ä¿¡æ¯</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">y</span> 
        <span class="n">o</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">s</span> 
        <span class="n">sigma</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">theta</span>

        <span class="c1"># è·å–å°ºåº¦ç©ºé—´æ¢¯åº¦</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">im_dx</span><span class="o">.</span><span class="n">ws</span><span class="p">[</span><span class="n">o</span><span class="p">],</span> <span class="n">im_dx</span><span class="o">.</span><span class="n">hs</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">im_dx</span><span class="o">.</span><span class="n">deltas</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="n">im_dx</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">im_dy</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="c1"># è½¬æ¢åˆ°åŸå›¾å°ºåº¦</span>
        <span class="n">x</span> <span class="o">/=</span> <span class="n">delta</span>
        <span class="n">y</span> <span class="o">/=</span> <span class="n">delta</span>
        <span class="n">sigma</span> <span class="o">/=</span> <span class="n">delta</span>

        <span class="n">key</span><span class="o">.</span><span class="n">init_descr</span><span class="p">(</span><span class="n">n_descr</span><span class="p">)</span>
        <span class="n">extract_sift_feature_vector</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">n_hist</span><span class="p">,</span> <span class="n">n_ori</span><span class="p">,</span> <span class="n">lambda_descr</span><span class="p">,</span>  <span class="n">key</span><span class="p">)</span>
        <span class="n">threshold_quantize_feature_vector</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">n_descr</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>



<span class="c1">#--------------siftç®—æ³•è°ƒç”¨-------------</span>
<span class="k">def</span> <span class="nf">num_of_octave</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">delta_min</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è®¡ç®—å›¾åƒé‡‘å­—å¡”çš„å±‚æ•°</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hmin</span> <span class="o">=</span> <span class="mi">12</span> <span class="c1"># æœ€é¡¶å±‚çš„å›¾åƒå¤§å°</span>
    <span class="n">h0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="n">delta_min</span> <span class="c1"># æœ€åº•å±‚å›¾åƒå¤§å°</span>
    <span class="n">n_oct</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">h0</span><span class="o">/</span><span class="n">hmin</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">n_oct</span>

<span class="k">def</span> <span class="nf">get_thresh</span><span class="p">(</span><span class="n">n_spo</span><span class="p">,</span> <span class="n">c_dog</span><span class="p">):</span>
    <span class="n">k_nspo</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">n_spo</span><span class="p">)</span>
    <span class="n">k_3</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">k_nspo</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">k_3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">c_dog</span>
    <span class="k">return</span> <span class="n">thresh</span>


<span class="k">def</span> <span class="nf">sift_algorithm</span><span class="p">(</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
        <span class="n">n_oct</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">n_spo</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="c1"># å›¾åƒé‡‘å­—å¡”å‚æ•°</span>
        <span class="n">c_dog</span><span class="o">=</span><span class="mf">0.013333333</span><span class="p">,</span> <span class="c1">#0.04/3</span>
        <span class="n">delta_min</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">sigma_min</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">sigma_in</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">lambda_ori</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="c1"># æ–¹å‘åŒ¹é…å‚æ•°</span>
        <span class="n">c_edge</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1"># è¾¹ç¼˜å“åº”é˜ˆå€¼</span>
        <span class="n">t</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">n_hist</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_ori</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">lambda_descr</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="c1"># siftæè¿°ç®—å­å‚æ•°</span>
        <span class="n">iter_max</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span> <span class="c1"># æ±‚æå€¼ç‚¹æ’å€¼è¿­ä»£æ¬¡æ•°</span>

    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">n_oct</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_of_octave</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">n_oct</span><span class="p">)</span>

    <span class="c1">#-------------ç”Ÿæˆå›¾åƒé‡‘å­—å¡”-------------</span>
    <span class="c1"># é«˜æ–¯é‡‘å­—å¡”</span>
    <span class="n">g_scale</span> <span class="o">=</span> <span class="n">gaussian_scale_space</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">sigma_in</span><span class="o">=</span><span class="n">sigma_in</span><span class="p">,</span> <span class="n">sigma_min</span><span class="o">=</span><span class="n">sigma_min</span><span class="p">,</span> <span class="n">n_oct</span><span class="o">=</span><span class="n">n_oct</span><span class="p">,</span> <span class="n">n_spo</span><span class="o">=</span><span class="n">n_spo</span><span class="p">)</span>
    <span class="c1"># å·®åˆ†é«˜æ–¯</span>
    <span class="n">dog_scale</span> <span class="o">=</span> <span class="n">scale_space_dog</span><span class="p">(</span><span class="n">g_scale</span><span class="p">)</span>


    <span class="c1"># è¾…åŠ©è¿‡ç¨‹ï¼Œç”¨äºå¯è§†åŒ–å›¾åƒé‡‘å­—å¡”</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">g_scale</span><span class="o">.</span><span class="n">n_oct</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">g_scale</span><span class="o">.</span><span class="n">n_sca</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">g_scale</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
            <span class="n">save_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./sift_result/g_</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">.jpg&#39;</span>
            <span class="n">io</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">save_name</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> 

    <span class="k">def</span> <span class="nf">pseudocolor</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">arr</span> <span class="o">-</span> <span class="n">arr</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">arr</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">*</span> <span class="mi">120</span>
        <span class="n">hsv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Convert hsv color (h,1,1) to its rgb equivalent.</span>
        <span class="k">return</span> <span class="n">color</span><span class="o">.</span><span class="n">hsv2rgb</span><span class="p">(</span><span class="n">hsv</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dog_scale</span><span class="o">.</span><span class="n">n_oct</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dog_scale</span><span class="o">.</span><span class="n">n_sca</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">dog_scale</span><span class="o">.</span><span class="n">octave</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">pseudo</span> <span class="o">=</span> <span class="n">pseudocolor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">pseudo</span>
            <span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
            <span class="n">save_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./sift_result/d_</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">.jpg&#39;</span>
            <span class="n">io</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">save_name</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> 


    <span class="c1">#--------------å…³é”®ç‚¹æ£€æµ‹-------------</span>
    <span class="n">keypoints</span> <span class="o">=</span> <span class="n">keypoints_find_3d_discrete_extrema</span><span class="p">(</span><span class="n">dog_scale</span><span class="p">)</span>

    <span class="c1"># è®¡ç®—å…³é”®ç‚¹é˜ˆå€¼</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">get_thresh</span><span class="p">(</span><span class="n">n_spo</span><span class="p">,</span> <span class="n">c_dog</span><span class="p">)</span>
    <span class="n">keypoints_rm_low</span> <span class="o">=</span> <span class="n">keypoints_discard_with_low_response</span><span class="p">(</span><span class="n">keypoints</span><span class="p">,</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">thresh</span><span class="p">)</span>
    <span class="c1"># å¯¹å…³é”®ç‚¹è¿›è¡Œæ’å€¼ï¼Œè·å–æ›´ç²¾ç¡®çš„ä½ç½®</span>
    <span class="n">keypoints_interp</span> <span class="o">=</span> <span class="n">keypoints_interpolate_position</span><span class="p">(</span><span class="n">dog_scale</span><span class="p">,</span> <span class="n">keypoints_rm_low</span><span class="p">,</span> <span class="n">iter_max</span><span class="p">)</span>

    <span class="n">keyp_rm_low_again</span> <span class="o">=</span> <span class="n">keypoints_discard_with_low_response</span><span class="p">(</span><span class="n">keypoints_interp</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span>

    <span class="c1"># jè®¡ç®—è¾¹ç¼˜å“åº”</span>
    <span class="n">keypoints_edge_response</span><span class="p">(</span><span class="n">dog_scale</span><span class="p">,</span> <span class="n">keyp_rm_low_again</span><span class="p">)</span>
    <span class="c1"># ç§»é™¤ä¸è‰¯è¾¹ç¼˜å“åº”</span>
    <span class="n">keys_rm_edge_rep</span> <span class="o">=</span> <span class="n">keypoints_discard_with_edge_resp</span><span class="p">(</span><span class="n">keyp_rm_low_again</span><span class="p">,</span> <span class="p">(</span><span class="n">c_edge</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">c_edge</span><span class="p">)</span>

    <span class="c1">#--------------å…³é”®ç‚¹æè¿°-------------</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">g_scale</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">g_scale</span><span class="p">)</span>
    <span class="n">scale_compute_gradient</span><span class="p">(</span><span class="n">g_scale</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>  <span class="c1"># é¢„è®¡ç®—ä¸¤ä¸ªæ–¹å‘çš„å·®åˆ†</span>

    <span class="c1"># è®¡ç®—å…³é”®ç‚¹çš„ä¸»è¦æ–¹å‘å’Œè¾…åŠ©æ–¹å‘</span>
    <span class="n">keys_attr_ori</span> <span class="o">=</span> <span class="n">keypoints_attribute_orientations</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">keys_rm_edge_rep</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">lambda_ori</span><span class="o">=</span><span class="n">lambda_ori</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># ç”Ÿæˆå…³é”®ç‚¹æè¿°</span>
    <span class="n">keypoints_attribute_descriptors</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">keys_attr_ori</span><span class="p">,</span> <span class="n">n_hist</span><span class="o">=</span><span class="n">n_hist</span><span class="p">,</span> <span class="n">n_ori</span><span class="o">=</span><span class="n">n_ori</span><span class="p">,</span> <span class="n">lambda_descr</span><span class="o">=</span><span class="n">lambda_descr</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;number of keypoints: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">keys_attr_ori</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">keys_attr_ori</span>

<span class="k">def</span> <span class="nf">draw_sift_result</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="n">KeyPoint</span><span class="p">],</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">3.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;åœ¨å›¾åƒä¸Šç»˜åˆ¶æ£€æµ‹å‡ºçš„SIFTå…³é”®ç‚¹</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">theta</span>
        <span class="c1"># print(theta)</span>
        <span class="n">sigma</span> <span class="o">*=</span> <span class="n">factor</span> <span class="c1"># æ”¾å¤§å€æ•°,</span>
        <span class="n">end_x</span><span class="p">,</span> <span class="n">end_y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">([(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">),</span> <span class="p">(</span><span class="n">end_y</span><span class="p">,</span> <span class="n">end_x</span><span class="p">)],</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

        <span class="n">draw</span><span class="o">.</span><span class="n">ellipse</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">sigma</span><span class="p">,</span> <span class="n">x</span><span class="o">-</span><span class="n">sigma</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">sigma</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="n">sigma</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

    <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sift_match</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">img_path</span> <span class="o">=</span> <span class="s1">&#39;./img/sift/download.png&#39;</span>

    <span class="c1"># img_path = &#39;./img/sift/jobs.jfif&#39;</span>
    <span class="n">img_path</span> <span class="o">=</span> <span class="s1">&#39;./img/sift/images.jfif&#39;</span>

    <span class="n">base</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">img_RGB</span><span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

    <span class="n">siftDetector</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">xfeatures2d</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>
    <span class="n">kp</span> <span class="o">=</span> <span class="n">siftDetector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">img_RGB</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">kp</span><span class="p">,</span><span class="n">des</span> <span class="o">=</span> <span class="n">siftDetector</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">img_RGB</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span>
    <span class="c1"># å…³é”®ç‚¹åˆ—è¡¨</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cv2 æ£€æµ‹æ•°é‡:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># desæ˜¯ä¸€ä¸ªå¤§å°ä¸ºå…³é”®ç‚¹æ•°ç›®*128çš„æ•°ç»„</span>
    <span class="c1"># print type(des),des.shape</span>
    <span class="n">im</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">drawKeypoints</span><span class="p">(</span><span class="n">img_RGB</span><span class="p">,</span><span class="n">kp</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">DRAW_MATCHES_FLAGS_DRAW_RICH_KEYPOINTS</span><span class="p">)</span>

    <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./sift_result/cv2_</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s1">.png&#39;</span>
    <span class="n">io</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>


    <span class="n">img</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">sift_algorithm</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./sift_result/</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s1">.png&#39;</span>
    <span class="n">draw_sift_result</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>
</code></pre></div>

<p>ğŸ§</p>
    </div><!-- /.entry-content -->


  </article>


</section>

<div id="comments">
  <h2 style="margin-top: 0.1rem;">Comments !</h2>
  <div id="gitalk-container"></div>
</div>
<script>
  var gitalk = new Gitalk({
    clientID: '4dfbf5aad180623dc634',
    clientSecret: '4c7167883746062103d9dbc2ec8b1ddfd6780d58',
    repo: 'steermomo.github.io',
    owner: 'steermomo',
    admin: ['steermomo'],
    id: location.pathname,      // Ensure uniqueness and length less than 50
    distractionFreeMode: false,  // Facebook-like distraction free mode
    createIssueManually: true,
  })
  gitalk.render('gitalk-container')
</script>
        <section id="extras" class="body">
        </section><!-- /#extras -->
<footer id="contentinfo" class="body">
  <address id="about" class="vcard body">
    Copyright Â© 2024
    </br>
    Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a
      href="http://python.org">Python</a>.
  </address>

  <!-- /#about -->


</footer><!-- /#contentinfo -->



</body>

</html>