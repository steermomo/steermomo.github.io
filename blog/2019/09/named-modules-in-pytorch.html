<!DOCTYPE html>
<html lang="en">

<head>
        <meta name="google-site-verification" content="d0pvXqLPH8JyCfWVyhZ7njhGUndRFIR95YM3myMb7rU" />
        <meta charset="utf-8" />
        <meta http-equiv="Cache-Control" content="no-transform" />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=yes" />
        <title>Pytorchä¸­çš„named_modulesæ˜¯ä¸ªå•¥-debugçœŸéš¾</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


        <link rel="stylesheet" href="//unpkg.com/heti/umd/heti.min.css">

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <!-- <h1><a href="/">steer </a></h1> -->
                <nav>
                        <ul>
                                <li><a href="/">ğŸ¦‰</a></li>
                                <li><a href="/blog">Blog</a></li>
                                <li><a href="/archives">Archives</a></li>
                                <li><a href="/gallery">Gallery</a></li>
                                <li id="navName">steer </li>
                        </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/blog/2019/09/named-modules-in-pytorch" rel="bookmark" title="Permalink to Pytorchä¸­çš„named_modulesæ˜¯ä¸ªå•¥-debugçœŸéš¾">Pytorchä¸­çš„named_modulesæ˜¯ä¸ªå•¥-debugçœŸéš¾</a>
      </h1>
    </header>

    <div class="entry-content">
<div class="post-meta">
        Date: <span >
               2019-09-05 Thu
        </span>
<span>Category: <a href="/category/pytorch/">Pytorch</a></span>
<!-- <p>tags: <a href="/tags/python/">Python</a> <a href="/tags/pytorch/">Pytorch</a> </p> -->

</div><!-- /.post-info -->

      <p>Summary =&gt;  åœ¨æ”¹å†™deeplabv3+æ—¶, å› ä¸ºéœ€è¦å»æ‰ASPPå’Œdecoderéƒ¨åˆ†, ä»…ä¿ç•™mobilenetçš„backbone. ä½†æ˜¯å› ä¸ºè¯¯å¯¹<code>nn.Module</code>å†…çš„æ‰€æœ‰æƒå€¼è¿›è¡Œåˆå§‹åŒ–, å¯¼è‡´backboneä¸­çš„é¢„è®­ç»ƒæƒå€¼ä¸¢å¤±. åŒæ ·çš„æ¨¡å‹è®­ç»ƒ1000ä¸ªepochçš„æ•ˆæœä¾ç„¶å¾ˆå·®.</p>
<p><img src="/images/file_3938986.jpg" style="max-width: 30%"></p>
<p>è¿™å‡ å¤©é‡åˆ°äº†ä¸€ä¸ªååˆ†å¥‡æ€ªçš„é—®é¢˜, å®éªŒéœ€è¦ç”¨åˆ°mobilenetv2ä½œä¸ºbackboneçš„deeplabv3+åšåˆ†å‰², åœ¨å¯¹æ¯”å®éªŒä¸­éœ€è¦ä¸¢æ‰ASPPå’Œdecoderéƒ¨åˆ†, å³backboneåé¢ç›´æ¥æ¥ä¸Šä¸¤å±‚å·ç§¯.  </p>
<p>æœ€å¼€å§‹æ˜¯ç›´æ¥åœ¨åŸæ¥çš„deeplabv3+çš„ä»£ç ä¸Šé­”æ”¹, å³åˆ›å»ºæ–°çš„ASPPç»“æ„ç›´æ¥è¿”å›input, å†åˆ›å»ºæ–°çš„decoderéƒ¨åˆ†åªæ¥å—high level featureä½œä¸ºè¾“å‡º. </p>
<p>ä½†æ˜¯è¿™æ ·ä¿®æ”¹çš„æ¨¡å‹, åœ¨æµ‹è¯•é€Ÿåº¦æ—¶æ¯”åŸå§‹çš„MobileNetV2è¦æ…¢å¾ˆå¤š, æ²¡æ³•ç»™å‡ºæ­£ç¡®çš„æ€§èƒ½æ•°æ®. ä½†æ˜¯åŸå§‹çš„MobileNetåˆå¥½åƒæ²¡æœ‰ç›´æ¥æŒ‡å®š<code>out_stride</code>çš„åœ°æ–¹. æˆ‘å°±æŒ‰ç…§ä¿®æ”¹åçš„ASPPè·Ÿdecoderéƒ¨åˆ†, åœ¨deeplabv3+çš„backboneåé¢åŠ äº†ä¸¤å±‚å·ç§¯. æµ‹å®Œé€Ÿåº¦, æ•ˆæœè¾¾åˆ°, ååˆ†å¼€å¿ƒ.</p>
<p>åœ¨åç»­è·‘å®éªŒçš„è¿‡ç¨‹ä¸­, å‘ç°åé¢å†™çš„è¿™ä¸ªæ¨¡å‹, è™½ç„¶èƒ½è®­ç»ƒ, èƒ½æ”¶æ•›, æ•ˆæœå¥‡å·®.</p>
<p>åé¢çš„æ¨¡å‹, å®šä¹‰æ›´åŠ ç®€å•, åœ¨ç»“æ„ä¸Šæ›´æ˜¯ä¸€æ¨¡ä¸€æ ·, ç”¨torchsummaryè¾“å‡ºä¸¤ä¸ªæ¨¡å‹çš„ç»“æ„, æ›´æ˜¯ä¸€ç‚¹æ²¡å·®, ä½œä¸ºå¯¹æ¯”, ä½¿ç”¨äº†åŒä¸€ä»½è®­ç»ƒä»£ç , å®Œå…¨ç›¸åŒçš„è®­ç»ƒå‚æ•°, åè€…çš„æ•ˆæœä»ç„¶æ˜¯æ— é™é€¼è¿‘ä½†æ°¸è¿œè¾¾ä¸åˆ°å‰è€…10ä¸ªepochçš„æ•ˆæœ. ä¸æ˜¯ç„å­¦å°±æ˜¯Bug.</p>
<p>åŸå§‹çš„deeplabv3+çš„ä»£ç å®šä¹‰æ˜¯è¿™æ ·çš„</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DeepLab</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backbone</span><span class="o">=</span><span class="s1">&#39;resnet&#39;</span><span class="p">,</span> <span class="n">output_stride</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>
                 <span class="n">sync_bn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">freeze_bn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deeplab_header</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DeepLab</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span> <span class="o">=</span> <span class="n">build_backbone</span><span class="p">(</span><span class="n">backbone</span><span class="p">,</span> <span class="n">output_stride</span><span class="p">,</span> <span class="n">BatchNorm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aspp</span> <span class="o">=</span> <span class="n">build_aspp</span><span class="p">(</span><span class="n">backbone</span><span class="p">,</span> <span class="n">output_stride</span><span class="p">,</span> <span class="n">BatchNorm</span><span class="p">,</span> <span class="n">deeplab_header</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">build_decoder</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">backbone</span><span class="p">,</span> <span class="n">BatchNorm</span><span class="p">,</span> <span class="n">deeplab_header</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">freeze_bn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freeze_bn</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">low_level_feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aspp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">low_level_feat</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">freeze_bn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">SynchronizedBatchNorm2d</span><span class="p">):</span>
                <span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
                <span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_1x_lr_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modules</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SynchronizedBatchNorm2d</span><span class="p">)</span> \
                        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">get_10x_lr_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">aspp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modules</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SynchronizedBatchNorm2d</span><span class="p">)</span> \
                        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">p</span>
</code></pre></div>

<p>ä¿®æ”¹ä¹‹åçš„ä»£ç ç›´æ¥å°†ASPPå’Œdecoderçš„å†…å®¹æ‹¿äº†å‡ºæ¥.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MobilenetV2</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_stride</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">sync_bn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">freeze_bn</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MobilenetV2</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sync_bn</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">BatchNorm</span> <span class="o">=</span> <span class="n">SynchronizedBatchNorm2d</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">BatchNorm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feat_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">320</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">BatchNorm</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_weight</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">mob_feat</span><span class="p">,</span> <span class="n">low_level_feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">last_feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feat_conv</span><span class="p">(</span><span class="n">mob_feat</span><span class="p">)</span>
        <span class="n">prob_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_conv</span><span class="p">(</span><span class="n">last_feat</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">prob_map</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">get_1x_lr_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modules</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SynchronizedBatchNorm2d</span><span class="p">)</span> \
                        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">get_10x_lr_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_conv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_conv</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modules</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SynchronizedBatchNorm2d</span><span class="p">)</span> \
                        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">_init_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">SynchronizedBatchNorm2d</span><span class="p">):</span>
                <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
                <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
</code></pre></div>

<p>è¿™é‡Œå”¯ä¸€æ˜¾è‘—çš„æ”¹å˜å°±æ˜¯å°†ASPPå’Œdecoderçš„å†…å®¹æ‹¿äº†å‡ºæ¥.</p>
<p><br></p>
<h3>named_modules</h3>
<blockquote>
<p>Returns an iterator over all modules in the network, yielding both the name of the module as well as the module itself.</p>
</blockquote>
<p>åœ¨torch.nn.modules.moduleçš„æºç ä¸­, named_modulesçš„å®ç°æ˜¯è¿™æ ·çš„</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">named_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">memo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">memo</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">memo</span><span class="p">:</span>
        <span class="n">memo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">submodule_prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="k">if</span> <span class="n">prefix</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">name</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">named_modules</span><span class="p">(</span><span class="n">memo</span><span class="p">,</span> <span class="n">submodule_prefix</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">m</span>
</code></pre></div>

<p>å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªè°ƒç”¨è¿‡ç¨‹æ˜¯é€’å½’è°ƒç”¨, é‚£æˆ‘æŠŠdecoderå†…çš„è¿ç®—ç”¨<code>nn.Module</code>åŒ…è£…èµ·æ¥å’Œæ‹¿åˆ°å¤–é¢åº”è¯¥æ²¡æœ‰åŒºåˆ«, æ€»ä¼šé€’å½’åˆ°æ‰€æœ‰çš„æˆå‘˜.</p>
<p>åœ¨Moduleç±»ä¸­, å¯ä»¥çœ‹åˆ°_modulesæ˜¯ä¸€ä¸ªæœ‰åºå­—å…¸.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_construct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes internal Module state, shared by both nn.Module and ScriptModule.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_log_api_usage_once</span><span class="p">(</span><span class="s2">&quot;python.nn_module&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span> <span class="o">=</span> <span class="n">thnn_backend</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_buffers</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_backward_hooks</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_forward_hooks</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_forward_pre_hooks</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict_hooks</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_load_state_dict_pre_hooks</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
</code></pre></div>

<p>emm...å½“æˆ‘å‘ç°<code>named_modules()</code>æ˜¯é€’å½’è°ƒç”¨çš„æ—¶å€™, æˆ‘è¿˜æ²¡æœ‰æ„è¯†åˆ°æ˜¯å“ªé‡Œå‡ºäº†é—®é¢˜, å½“æˆ‘çœ‹åˆ°<code>modules()</code>å®é™…ä¸Šæ˜¯è°ƒç”¨äº†<code>named_modules()</code>çš„æ—¶å€™,ğŸ™„.  </p>
<p>æ‰€ä»¥é—®é¢˜æ˜¯æˆ‘åœ¨æ”¹å†™äº†åŸæ¥deeplabv3+ä¹‹å, å› ä¸ºå°†ASPPå’Œdecoderçš„å†…å®¹éƒ½ç›´æ¥æ˜¾ç¤ºåœ°å†™åœ¨<code>forward()</code>æ–¹æ³•ä¸­, éœ€è¦å¯¹<code>feat_conv</code>å’Œ<code>prob_conv</code>åˆå§‹åŒ–, åˆå§‹åŒ–æ–¹æ³•ä¸­è°ƒç”¨äº†<code>modules()</code>éå†æ‰€æœ‰å­<code>Conv2d</code>, åˆå§‹åŒ–å…¶æƒé‡, æ‰€ä»¥å¯¼è‡´<code>backbone</code>ä¸­çš„æ‰€æœ‰æƒå€¼éƒ½è¢«åˆå§‹åŒ–äº†ğŸ˜¤. ä¸¢äº†é¢„è®­ç»ƒæƒå€¼, æ•ˆæœè‡ªç„¶å·®äº†ä¸€å¤§æˆª, è®­ç»ƒ1000ä¸ªepochéƒ½æŠµä¸è¿‡è®­ç»ƒ10ä¸ªepochçš„æ•ˆæœ.</p>
<p>æŠŠæƒé‡åˆå§‹åŒ–çš„éƒ¨åˆ†æ”¹ä¸ºè·³è¿‡backboneéƒ¨åˆ†, é—®é¢˜è§£å†³.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_init_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_conv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_conv</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modules</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">SynchronizedBatchNorm2d</span><span class="p">):</span>
                <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
                <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
</code></pre></div>

<p>Slide note: è™½ç„¶ç½—é‡Œå·´å½è®²äº†ä¸€å †æ²¡ç”¨çš„ä¸œè¥¿, ä¸è¿‡æ˜¯åœ¨å•°å—¦çš„è¿‡ç¨‹ä¸­å‘ç°äº†Bugçš„ä½ç½®, æˆ‘ä¸€ç›´ä»¥ä¸ºæ˜¯å› ä¸ºå¥—äº†ä¸€å±‚<code>nn.Module</code>å¯¼è‡´<code>get_10x_lr_params()</code>æ–¹æ³•ä¸èƒ½æ­£ç¡®è¿”å›å‚æ•°, æ’é™¤äº†å‡ ä¸ªé—®é¢˜ä¹‹åæ‰å‘ç°Bugè¿™ä¹ˆæ˜æ˜¾. </p>
<p>æˆ‘å†³å®šsave&amp;push, åˆ¶é€ äº’è”ç½‘åƒåœ¾.</p>
    </div><!-- /.entry-content -->


  </article>


</section>

<div id="comments">
  <h2 style="margin-top: 0.1rem;">Comments !</h2>
  <div id="gitalk-container"></div>
</div>
<script>
  var gitalk = new Gitalk({
    clientID: '4dfbf5aad180623dc634',
    clientSecret: '4c7167883746062103d9dbc2ec8b1ddfd6780d58',
    repo: 'steermomo.github.io',
    owner: 'steermomo',
    admin: ['steermomo'],
    id: location.pathname,      // Ensure uniqueness and length less than 50
    distractionFreeMode: false,  // Facebook-like distraction free mode
    createIssueManually: true,
  })
  gitalk.render('gitalk-container')
</script>
        <section id="extras" class="body">
        </section><!-- /#extras -->
<footer id="contentinfo" class="body">
  <address id="about" class="vcard body">
    Copyright Â© 2024
    </br>
    Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a
      href="http://python.org">Python</a>.
  </address>

  <!-- /#about -->


</footer><!-- /#contentinfo -->



</body>

</html>