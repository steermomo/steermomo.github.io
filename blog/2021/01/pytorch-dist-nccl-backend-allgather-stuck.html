<!DOCTYPE html>
<html lang="en">

<head>
        <meta name="google-site-verification" content="d0pvXqLPH8JyCfWVyhZ7njhGUndRFIR95YM3myMb7rU" />
        <meta charset="utf-8" />
        <meta http-equiv="Cache-Control" content="no-transform" />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=yes" />
        <title>åœ¨NCCLåç«¯ä¸‹Pytorchçš„distributed.all_gatherå¡æ­»æ’æŸ¥</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


        <link rel="stylesheet" href="//unpkg.com/heti/umd/heti.min.css">

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <!-- <h1><a href="/">steer </a></h1> -->
                <nav>
                        <ul>
                                <li><a href="/">ğŸ¦‰</a></li>
                                <li><a href="/blog">Blog</a></li>
                                <li><a href="/archives">Archives</a></li>
                                <li><a href="/gallery">Gallery</a></li>
                                <li id="navName">steer </li>
                        </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/blog/2021/01/pytorch-dist-nccl-backend-allgather-stuck" rel="bookmark" title="Permalink to åœ¨NCCLåç«¯ä¸‹Pytorchçš„distributed.all_gatherå¡æ­»æ’æŸ¥">åœ¨NCCLåç«¯ä¸‹Pytorchçš„distributed.all_gatherå¡æ­»æ’æŸ¥</a>
      </h1>
    </header>

    <div class="entry-content">
<div class="post-meta">
        Date: <span >
               2021-01-05 Tue
        </span>
<span>Category: <a href="/category/coding/">Coding</a></span>
<!-- <p>tags: <a href="/tags/pytorch/">PyTorch</a> <a href="/tags/python/">Python</a> </p> -->

</div><!-- /.post-info -->

      <p>ç”¨äº†Githubä¸Šä¸€ä¸ª<a href="https://github.com/Spijkervet/SimCLR">SimCLRçš„PyTorchå®ç°</a>ï¼Œä½†æ˜¯åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚</p>
<p>åŸrepoè¦ç”¨DDPè®­ç»ƒçš„æ–¹å¼æœ‰ç‚¹è´¨æœ´ï¼Œéœ€è¦æ‰‹åŠ¨å¯åŠ¨Nçš„è¿›ç¨‹è¿›è¡Œè®­ç»ƒï¼Œé‚£8å¼ å¡å²‚ä¸æ˜¯è¦æ“ä½œå…«æ¬¡ï¼å®éªŒå¼€å¤šäº†è¦ç´¯æ­»äº†ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>python<span class="w"> </span>main.py<span class="w"> </span>--nodes<span class="w"> </span><span class="m">2</span><span class="w"> </span>--nr<span class="w"> </span><span class="m">0</span>
<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>python<span class="w"> </span>main.py<span class="w"> </span>--nodes<span class="w"> </span><span class="m">2</span><span class="w"> </span>--nr<span class="w"> </span><span class="m">1</span>
<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">2</span><span class="w"> </span>python<span class="w"> </span>main.py<span class="w"> </span>--nodes<span class="w"> </span><span class="m">2</span><span class="w"> </span>--nr<span class="w"> </span><span class="m">2</span>
<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span>N<span class="w"> </span>python<span class="w"> </span>main.py<span class="w"> </span>--nodes<span class="w"> </span><span class="m">2</span><span class="w"> </span>--nr<span class="w"> </span><span class="m">3</span>
</code></pre></div>

<h2>ä¸€è¡Œä»£ç èµ·</h2>
<p>è¿™è‚¯å®šä¸èƒ½å¿ï¼Œä¸ç¬¦åˆæˆ‘çš„é£æ ¼ï¼Œæˆ‘ä»é™ˆå¹´ä»£ç åŒ…é‡Œæ‹¿å‡ºäº†æˆ‘çš„é¡ºæ‰‹å·¥å…·ï¼Œèƒ½ä¸€è¡Œåšå®Œçš„äº‹æƒ…ç»ä¸ç”¨å…«è¡Œã€‚</p>
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>-m<span class="w"> </span>torch.distributed.launch<span class="w"> </span>--nproc_per_node<span class="w"> </span><span class="m">2</span><span class="w"> </span>--master_port<span class="o">=</span><span class="m">9495</span><span class="w"> </span>main.py
</code></pre></div>

<p>ä¸€è¡Œä»£ç èµ·ï¼å®Œç¾ï¼</p>
<p>åé¢è¿˜æœ‰ä¸€äº›æŠŠåˆ†å¸ƒå¼é€šè®¯çš„é…ç½®ä¿®æ”¹çš„é—®é¢˜ï¼Œæ¯”å¦‚ç§»é™¤</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Master address for distributed data parallel</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MASTER_ADDR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MASTER_PORT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;8000&quot;</span>
<span class="n">mp</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">args</span><span class="p">,),</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">gpus</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>åŠ ä¸Š</p>
<div class="highlight"><pre><span></span><code><span class="n">dist</span><span class="o">.</span><span class="n">init_process_group</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s1">&#39;nccl&#39;</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">local_rank</span><span class="p">)</span>
</code></pre></div>

<h2>Debugé Google</h2>
<p>å®Œäº‹äº†ï¼ŒDockerè°ƒèµ·ã€ç£ç›˜æŒ‚è½½ã€ç¨‹åºå¯åŠ¨...</p>
<p>ç„¶åå°±çœ‹è§GPU0å¡æ­»100%ï¼ŒGPU1-Nå‚»ç«™ç€ä¸åŠ¨ã€‚</p>
<p>è¿™ä¸è¡Œï¼Œä¸Šå·¥å…·å®šä½ï¼Œå‘ç°æ˜¯å¤šå¡é€šè®¯ä¸­å¡åœ¨dist.all_gatherè¿™ä¸€æ­¥ã€‚
è¿™é‡Œæœ‰ä¸€æ­¥å®ç°éœ€è¦å¯¹æ‰€æœ‰å¡ä¸Šçš„ç‰¹å¾è¿›è¡Œèšåˆè®¡ç®—æ­£è´Ÿæ ·æœ¬ï¼Œä½†åªå¸Œæœ›ä¿ç•™å½“å‰å¡å†…çš„æ¢¯åº¦ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">GatherLayer</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Gather tensors from all process, supporting backward propagation.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">save_for_backward</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> \
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">get_world_size</span><span class="p">())]</span>

        <span class="n">dist</span><span class="o">.</span><span class="n">all_gather</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">grads</span><span class="p">):</span>
        <span class="nb">input</span><span class="p">,</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">saved_tensors</span>
        <span class="n">grad_out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">grad_out</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">grads</span><span class="p">[</span><span class="n">dist</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">grad_out</span>
</code></pre></div>

<p>æƒ³ä¸‹ç­å›å®¶äº†...ä¸æƒ³å†™äº†ï¼Œåæ­£å°±æ˜¯å¯¹ç€Googleä¸€é¡¿çŒ›æœï¼Œå‘ç°æœ‰è·Ÿæˆ‘ä¸€æ ·çš„å€’éœ‰è›‹é‡åˆ°äº†ç±»ä¼¼çš„é—®é¢˜<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>ï¼Œå°±æ˜¯åœ¨NCCLåˆå§‹åŒ–init_process_groupä¹‹å‰ï¼Œéœ€è¦å…ˆä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…GPUï¼Œåˆ†é…å®Œäº‹äº†å°±æ²¡ä»»ä½•é—®é¢˜äº†ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
<span class="n">dist</span><span class="o">.</span><span class="n">init_process_group</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s1">&#39;nccl&#39;</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">local_rank</span><span class="p">)</span>
</code></pre></div>

<p>AP:
ğŸ¤£</p>
<p>ä¹‹å‰è¿˜é‡åˆ°è¿‡è¯¡å¼‚çš„M40å¡æ­»åœ¨dist.all_gatherï¼Œä½†æ˜¯åœ¨P40ä¸Šè¿è¡Œå°±ååˆ†æ­£å¸¸ï¼Œè¿˜æ‰¾äº†æœºå™¨å­¦ä¹ å¹³å°çš„åŒäº‹èŠ±äº†ä¸€ä¸‹åˆæ—¶é—´debugã€‚</p>
<p>ç°åœ¨å›å»æ£€æŸ¥å½“æ—¶å‡ºç°è¯¡å¼‚bugçš„ä»£ç ï¼Œæœç„¶æ˜¯æˆ‘å†™é”™äº†ï¼Œæˆ‘ç»™è¿™ä¸¤å¥å†™åäº†å•Šï¼ğŸ˜‘ğŸ™„</p>
<div class="highlight"><pre><span></span><code><span class="n">dist</span><span class="o">.</span><span class="n">init_process_group</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s1">&#39;nccl&#39;</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">local_rank</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">local_rank</span><span class="p">)</span>
</code></pre></div>

<div class="footnote">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://github.com/pytorch/pytorch/issues/18689">distributed.all_gather function stuck when using NCCL backend</a>&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
    </div><!-- /.entry-content -->


  </article>


</section>

<div id="comments">
  <h2 style="margin-top: 0.1rem;">Comments !</h2>
  <div id="gitalk-container"></div>
</div>
<script>
  var gitalk = new Gitalk({
    clientID: '4dfbf5aad180623dc634',
    clientSecret: '4c7167883746062103d9dbc2ec8b1ddfd6780d58',
    repo: 'steermomo.github.io',
    owner: 'steermomo',
    admin: ['steermomo'],
    id: location.pathname,      // Ensure uniqueness and length less than 50
    distractionFreeMode: false,  // Facebook-like distraction free mode
    createIssueManually: true,
  })
  gitalk.render('gitalk-container')
</script>
        <section id="extras" class="body">
        </section><!-- /#extras -->
<footer id="contentinfo" class="body">
  <address id="about" class="vcard body">
    Copyright Â© 2024
    </br>
    Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a
      href="http://python.org">Python</a>.
  </address>

  <!-- /#about -->


</footer><!-- /#contentinfo -->



</body>

</html>