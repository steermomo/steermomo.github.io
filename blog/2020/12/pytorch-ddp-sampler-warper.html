<!DOCTYPE html>
<html lang="en">

<head>
        <meta name="google-site-verification" content="d0pvXqLPH8JyCfWVyhZ7njhGUndRFIR95YM3myMb7rU" />
        <meta charset="utf-8" />
        <meta http-equiv="Cache-Control" content="no-transform" />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=yes" />
        <title>åœ¨PyTorch DistributedSamplerä¸­å°è£…å…¶ä»–Samplerç­–ç•¥</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


        <link rel="stylesheet" href="//unpkg.com/heti/umd/heti.min.css">

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <!-- <h1><a href="/">steer </a></h1> -->
                <nav>
                        <ul>
                                <li><a href="/">ğŸ¦‰</a></li>
                                <li><a href="/blog">Blog</a></li>
                                <li><a href="/archives">Archives</a></li>
                                <li><a href="/gallery">Gallery</a></li>
                                <li id="navName">steer </li>
                        </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/blog/2020/12/pytorch-ddp-sampler-warper" rel="bookmark" title="Permalink to åœ¨PyTorch DistributedSamplerä¸­å°è£…å…¶ä»–Samplerç­–ç•¥">åœ¨PyTorch DistributedSamplerä¸­å°è£…å…¶ä»–Samplerç­–ç•¥</a>
      </h1>
    </header>

    <div class="entry-content">
<div class="post-meta">
        Date: <span >
               2020-12-23 Wed
        </span>
<span>Category: <a href="/category/coding/">Coding</a></span>
<!-- <p>tags: <a href="/tags/python/">Python</a> <a href="/tags/pytorch/">PyTorch</a> </p> -->

</div><!-- /.post-info -->

      <p>ç”¨äº†PyTorchçš„åˆ†å¸ƒå¼è®­ç»ƒåï¼Œæˆ‘æŠŠæ‰€æœ‰çš„dataloaderéƒ½åŠ ä¸Šäº† DistributedSampler ã€‚</p>
<p>ç°åœ¨é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜æ˜¯éœ€è¦å¯¹ä¸åŒç±»åˆ«çš„æ ·æœ¬è¿›è¡Œé‡‡æ ·ï¼Œè€ŒPytTorchè‡ªå¸¦çš„WeightedRandomSampler åˆä¸æ˜¯é‚£ä¹ˆå›äº‹ï¼Œä¸èƒ½ç›´æ¥å¯¹ç±»åˆ«è¿›è¡Œé‡‡æ ·ï¼Œç´¢æ€§è‡ªå·±é€ äº†ä¸ªè½®å­è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2>WeightedBalanceClassSampler</h2>
<p>é¦–å…ˆè¦è§£å†³çš„æ˜¯å¯¹æ¯ä¸ªç±»åˆ«è¿›è¡Œé‡‡æ ·ï¼Œè¿™é‡Œç”¨äº†catalystçš„ä¸€éƒ¨åˆ†ä»£ç <sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>ã€‚catalystæä¾›äº†ä¸€ä¸ª BalanceClassSampler å®ç°ç±»åˆ«å‡è¡¡é‡‡æ ·ï¼Œä½†åœ¨æˆ‘çš„åœºæ™¯ä¸‹ï¼Œç±»åˆ«ä¸å‡è¡¡æ¯”è¾ƒä¸¥é‡ï¼ŒBalanceClassSampler é‡Œå°†æ‰€æœ‰ç±»çš„æ•°é‡ç›´æ¥å¡«æˆä¸€æ ·çš„äº†ï¼Œä¸æ»¡è¶³æˆ‘çš„è¦æ±‚ã€‚</p>
<p>åœ¨ BalanceClassSampler çš„åŸºç¡€ä¸Šï¼Œè¿™é‡Œå®ç°äº† WeightedBalanceClassSampler ç”¨äºå¸¦æƒé‡‡æ ·ã€‚
ç”¨ weight æŒ‡å®šæ¯ä¸ªç±»åˆ«çš„é‡‡æ ·æ¯”ä¾‹ï¼Œç”¨lengthæŒ‡å®šé‡‡æ ·åæ•°æ®é›†çš„å¤§å°ã€‚</p>
<p>weight å½’ä¸€åŒ–åï¼Œä¹˜ä¸Šlengthè®¡ç®—é‡‡æ ·åæ¯ä¸ªçš„æ•°ç›®ï¼Œä½¿ç”¨ saferound ä¿è¯ç±»å‹è½¬æ¢åsampleçš„æ€»æ•°ä»ç„¶æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>åœ¨ __iter__ æ–¹æ³•ä¸­ ä½¿ç”¨ np.random.choice å¯¹æ¯ä¸ªç±»åˆ«ä¸‹çš„ç´¢å¼•è¿›è¡Œé‡‡æ ·ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WeightedBalanceClassSampler</span><span class="p">(</span><span class="n">Sampler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Allows you to create stratified sample on unbalanced classes with given probabilities (weights).</span>
<span class="sd">    Args:</span>
<span class="sd">        labels: list of class label for each elem in the dataset</span>
<span class="sd">        weight: A sequence of weights to balance classes, not necessary summing up to one.</span>
<span class="sd">        length: the length of the sample dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">weight</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sampler initialisation.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lbl2idx</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">label</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">/</span> <span class="n">weight</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">samples_per_class</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">length</span>

        <span class="n">samples_per_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">saferound</span><span class="p">(</span><span class="n">samples_per_class</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_class</span> <span class="o">=</span> <span class="n">samples_per_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Yields:</span>
<span class="sd">            indices of stratified sample</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lbl2idx</span><span class="p">):</span>
            <span class="n">replace_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_class</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lbl2idx</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">indices</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lbl2idx</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_class</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">replace</span><span class="o">=</span><span class="n">replace_flag</span>
            <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">             length of result sample</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span>
</code></pre></div>

<h2>DistributedSamplerWrapper</h2>
<p>PyTorchçš„DistributedSampleræ˜¯ç›´æ¥å¯¹datasetè¿›è¡Œå°è£…ï¼Œè¿™é‡Œåœ¨å·²ç»å°è£…äº†ä¸€å±‚ WeightedBalanceClassSampler åï¼Œéœ€è¦å°†å†…éƒ¨çš„ sampler å†æ”¾åˆ°DistributedSampler å†…ã€‚</p>
<p>è¿™é‡Œä»ç„¶æ˜¯ç”¨äº†catalystçš„ä¸¤ä¸ªç±»ï¼šDatasetFromSamplerå’ŒDistributedSamplerWrapperã€‚</p>
<p>å…¶ä¸­ DatasetFromSampler å°†å†…éƒ¨çš„sampleråŒ…è£…æˆdatasetçš„æ¥å£ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DatasetFromSampler</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dataset to create indexes from `Sampler`.</span>
<span class="sd">    Args:</span>
<span class="sd">        sampler: PyTorch sampler</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sampler</span><span class="p">:</span> <span class="n">Sampler</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialisation for DatasetFromSampler.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="o">=</span> <span class="n">sampler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampler_list</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets element of the dataset.</span>
<span class="sd">        Args:</span>
<span class="sd">            index: index of the element in the dataset</span>
<span class="sd">        Returns:</span>
<span class="sd">            Single element by index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sampler_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            int: length of the dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="p">)</span>
</code></pre></div>

<p>è€ŒDistributedSamplerWrapperæ˜¯ç»§æ‰¿è‡ªPyTorchè‡ªå¸¦çš„DistributedSamplerã€‚</p>
<p>çœ‹ PyTorch DistributedSamplerçš„æºç <sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>å¯ä»¥çŸ¥é“ï¼Œç»§æ‰¿åéœ€è¦è¦†å†™å®ƒçš„ __iter__ æ–¹æ³•ï¼Œå®ç°è‡ªå·±çš„è¿­ä»£è¿‡ç¨‹ã€‚</p>
<p>çˆ¶ç±» DistributedSamplerçš„ __iter__ æ–¹æ³•ä¼šè¿”å›å½“å‰rankä¸‹çš„dataset ç´¢å¼•ï¼Œå³å·²ç»å¤„ç†å¥½äº†åˆ†å¸ƒå¼ä¸‹çš„samplerï¼Œé‚£åœ¨è¿™é‡Œå¯ä»¥ä½¿ç”¨çˆ¶ç±»è¿”å›çš„ç´¢å¼•å€¼ï¼Œå¯¹å†…éƒ¨çš„ WeightedBalanceClassSampler å†è¿›è¡Œä¸€æ¬¡ç´¢å¼•ï¼Œå®ç°å¯¹ WeightedBalanceClassSampler çš„å°è£…ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DistributedSamplerWrapper</span><span class="p">(</span><span class="n">DistributedSampler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper over `Sampler` for distributed training.</span>
<span class="sd">    Allows you to use any sampler in distributed mode.</span>
<span class="sd">    It is especially useful in conjunction with</span>
<span class="sd">    `torch.nn.parallel.DistributedDataParallel`. In such case, each</span>
<span class="sd">    process can pass a DistributedSamplerWrapper instance as a DataLoader</span>
<span class="sd">    sampler, and load a subset of subsampled data of the original dataset</span>
<span class="sd">    that is exclusive to it.</span>
<span class="sd">    .. note::</span>
<span class="sd">        Sampler is assumed to be of constant size.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sampler</span><span class="p">,</span>
        <span class="n">num_replicas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            sampler: Sampler used for subsampling</span>
<span class="sd">            num_replicas (int, optional): Number of processes participating in</span>
<span class="sd">              distributed training</span>
<span class="sd">            rank (int, optional): Rank of the current process</span>
<span class="sd">              within ``num_replicas``</span>
<span class="sd">            shuffle (bool, optional): If true (default),</span>
<span class="sd">              sampler will shuffle the indices</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DistributedSamplerWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">DatasetFromSampler</span><span class="p">(</span><span class="n">sampler</span><span class="p">),</span>
            <span class="n">num_replicas</span><span class="o">=</span><span class="n">num_replicas</span><span class="p">,</span>
            <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="o">=</span> <span class="n">sampler</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;@TODO: Docs. Contribution is welcome.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">DatasetFromSampler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="p">)</span>
        <span class="n">indexes_of_indexes</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>
        <span class="n">subsampler_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">indexes_of_indexes</span><span class="p">)(</span><span class="n">subsampler_indexes</span><span class="p">))</span>
</code></pre></div>

<div class="footnote">
<hr>
<ol>
<li id="fn:1">
<p>https://github.com/catalyst-team/catalyst/blob/master/catalyst/data/sampler.py&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>https://github.com/pytorch/pytorch/blob/master/torch/utils/data/distributed.py&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
    </div><!-- /.entry-content -->


  </article>


</section>

<div id="comments">
  <h2 style="margin-top: 0.1rem;">Comments !</h2>
  <div id="gitalk-container"></div>
</div>
<script>
  var gitalk = new Gitalk({
    clientID: '4dfbf5aad180623dc634',
    clientSecret: '4c7167883746062103d9dbc2ec8b1ddfd6780d58',
    repo: 'steermomo.github.io',
    owner: 'steermomo',
    admin: ['steermomo'],
    id: location.pathname,      // Ensure uniqueness and length less than 50
    distractionFreeMode: false,  // Facebook-like distraction free mode
    createIssueManually: true,
  })
  gitalk.render('gitalk-container')
</script>
        <section id="extras" class="body">
        </section><!-- /#extras -->
<footer id="contentinfo" class="body">
  <address id="about" class="vcard body">
    Copyright Â© 2024
    </br>
    Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a
      href="http://python.org">Python</a>.
  </address>

  <!-- /#about -->


</footer><!-- /#contentinfo -->



</body>

</html>